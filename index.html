<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assyrian III: Verb to Order Game</title>

  <!-- Noto Sans Syriac Eastern -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Syriac+Eastern:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F7F9FC; --card:#FFFFFF; --ink:#0F172A; --muted:#475569;
      --accent:#2563EB; --success:#16A34A; --warn:#D97706; --danger:#DC2626; --line:#E5E7EB;
      --radius:16px; --active:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--ink); font:16px/1.4 "Segoe UI", system-ui, Arial, sans-serif;}
    .wrap{max-width:1220px; margin:24px auto; padding:0 16px;}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;}
    h1{font-size:22px; margin:0; font-weight:800;}
    .controls{display:flex; flex-wrap:wrap; align-items:center; gap:8px;}
    select, input[type="text"]{
      padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff; color:#0F172A;
    }
    .btn{appearance:none; border:0; padding:10px 14px; border-radius:10px; color:#fff; font-weight:700; cursor:pointer;}
    .btn.primary{background:var(--accent)}
    .btn.success{background:var(--success)}
    .btn.neutral{background:#334155}
    .btn.danger{background:#DC2626}
    .btn.warn{background:#D97706}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .pill{display:inline-block; padding:6px 12px; border-radius:999px; background:#EEF2FF; color:#3730A3; font-weight:800; font-size:13px;}
    .timer{font-size:56px; font-weight:800; color:var(--accent); margin:4px 0 8px}
    .prompt{font-size:30px; font-weight:800; margin:8px 0 6px}
    .food{font-size:18px; font-style:italic; color:var(--warn); margin:0 0 6px}
    .answer{font-family:"Noto Sans Syriac Eastern","Segoe UI",system-ui,Arial,sans-serif; font-size:48px; color:var(--success); margin:12px 0 18px}

    .row{display:flex; gap:16px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    .legend{color:var(--muted); font-size:12px}

    .card{background:var(--card); border-radius:var(--radius); padding:16px; box-shadow:0 1px 0 rgba(0,0,0,.04); border:1px solid var(--line);}
    .grid2{display:grid; grid-template-columns:1fr 310px; gap:16px;}

    .scores .team{min-width:260px; border-radius:16px; padding:14px; border:2px solid var(--line); background:#fff; transition:background .2s,border-color .2s, box-shadow .2s; cursor:pointer; position:relative}
    .scores .team:hover{box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .scores .team.active{box-shadow:0 0 0 3px rgba(14,165,233,.35); border-color:var(--active)}
    .scores .team.active::after{
      content:"Selected"; position:absolute; top:10px; right:12px;
      background:#0ea5e9; color:#fff; font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px;
    }
    .scores .team-title{font-size:18px; font-weight:800; margin-bottom:6px}
    .scores .score{font-size:26px; font-weight:800; margin:6px 0}
    .scores .grid{display:flex; gap:6px; flex-wrap:wrap}
    .point{padding:8px 10px; border-radius:10px; background:#E2E8F0; color:#0F172A; font-weight:800; border:1px solid #CBD5E1; cursor:pointer;}
    .point:hover{background:#CBD5E1}
    .team-bar{height:6px; border-radius:6px; background:#E5E7EB; overflow:hidden; margin-top:6px; position:relative}
    .team-bar .fill{height:100%; width:0%; transition:width .3s ease}
    .roundbar{height:8px; background:#E5E7EB; border-radius:8px; overflow:hidden}
    .roundbar .fill{height:100%; width:0%; background:var(--accent); transition:width .4s ease}
    .banner{margin:10px 0; padding:10px 14px; border-radius:10px; background:#ECFDF5; color:#065F46; border:1px solid #A7F3D0; font-weight:700}
    .hidden{display:none !important}
    .confetti{position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:hidden}
    .piece{position:absolute; width:8px; height:12px; opacity:.9; transform:translate3d(0,0,0); animation:fall 1400ms linear forwards;}
    @keyframes fall{0%{transform:translate3d(var(--x),-10vh,0) rotate(0deg);}100%{transform:translate3d(calc(var(--x) + var(--dx)),110vh,0) rotate(360deg);opacity:.7;}}
    .games-card .big{font-size:18px; font-weight:800}
    .note{font-size:12px; color:var(--muted)}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:50}
    .modal{background:#fff; border-radius:16px; padding:20px; max-width:720px; width:92%; border:1px solid var(--line); text-align:left}
    .modal h2{margin:6px 0 10px; font-size:22px}
    .modal .muted{color:#475569; font-size:14px}
    /* Multiple choice */
    .mc{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .mc .opt{flex:1 1 48%; padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:not-allowed}
    .mc .opt.enabled{cursor:pointer; background:#F8FAFC}
    .mc .opt.correct{border-color:#16A34A; background:#ECFDF5}
    .mc .opt.wrong{border-color:#DC2626; background:#FEF2F2}
    .lockpill{margin-left:8px}
    #currentTeamPill{border:1px solid var(--line)}

    /* History list */
    .history-list{max-height:340px; overflow:auto; margin-top:8px}
    .history-item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border:1px solid var(--line); border-radius:10px; margin-bottom:6px; background:#fff}
    .history-item .meta{font-size:12px; color:#475569}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Assyrian III: Verb to Order Game</h1>
      <div class="controls">
        <button class="btn neutral" id="fullscreenBtn" title="Toggle fullscreen">Fullscreen</button>

        <label class="legend" for="timerSelect">Timer:</label>
        <select id="timerSelect" title="Seconds per round">
          <option>20</option><option selected>30</option><option>45</option><option>60</option>
        </select>

        <label class="legend" for="roundsSelect">Rounds:</label>
        <select id="roundsSelect" title="Number of rounds">
          <option>5</option><option selected>10</option><option>15</option><option>20</option>
        </select>

        <label class="legend"><input type="checkbox" id="noRepeat" checked> No-repeat</label>

        <label class="legend" for="dirSelect">Direction:</label>
        <select id="dirSelect" title="Question direction">
          <option value="EN2SY" selected>English → Assyrian</option>
          <option value="SY2EN">Assyrian → English</option>
          <option value="BOTH">Both</option>
        </select>

        <label class="legend" for="qtypeSelect">Type:</label>
        <select id="qtypeSelect" title="Free / Multiple Choice / Mixed">
          <option value="FREE" selected>Free Response</option>
          <option value="MC">Multiple Choice</option>
          <option value="MIXED">Mixed</option>
        </select>

        <label class="legend" for="playersSelect">Players:</label>
        <select id="playersSelect" title="2 or 3 players">
          <option value="2" selected>2 Players</option>
          <option value="3">3 Players</option>
        </select>

        <button class="btn warn" id="resetGameBtn" title="Reset rounds, scores, and start from Round 1">Reset Game</button>
        <button class="btn danger" id="resetScoresBtn" title="Reset all teams to 0">Reset Scores</button>
        <button class="btn primary" id="instructionsBtn" title="Show instructions">Instructions</button>
      </div>
    </header>

    <div class="grid2">
      <!-- Left: Main play area -->
      <div>
        <div class="card" style="margin-bottom:10px">
          <div class="row">
            <div><strong>Round:</strong> <span id="roundNow">1</span>/<span id="roundTotal">10</span></div>
            <div class="spacer"></div>
            <div style="min-width:280px">
              <div class="roundbar" title="Round progress"><div class="fill" id="roundFill"></div></div>
            </div>
          </div>
          <div id="endNote" class="note hidden" style="margin-top:8px;"></div>
        </div>

        <div class="timer" id="timerLabel">30 sec</div>

        <!-- Current team pill -->
        <div id="currentTeamPill" class="pill hidden">Current Team: —</div>

        <div class="prompt" id="promptLabel"></div>
        <div class="food" id="foodLabel"></div>

        <div class="answer" id="answerLabel"></div>

        <!-- Multiple choice answers -->
        <div id="mcWrap" class="mc hidden"></div>
        <span id="mcLock" class="pill lockpill hidden">Options unlock after 10 sec</span>
        <span id="teamLock" class="pill lockpill hidden">Select your team to award points</span>

        <div class="row" style="margin-top:8px">
          <button class="btn success" id="showAnswerBtn" title="Reveal the answer and stop the timer" disabled>Show Answer</button>
          <button class="btn primary" id="nextBtn" title="Next random prompt (auto-starts timer)" disabled>Next Question</button>
          <span id="bonusPill" class="pill hidden">BONUS ROUND</span>
          <div class="spacer"></div>
          <div class="note">Multiple Choice: select your team first to earn/lose points • Space=Start/Pause • Enter=Next • A=Show</div>
        </div>

        <!-- Scores -->
        <div class="card scores" style="margin-top:14px">
          <div class="row">
            <!-- Team 1 -->
            <div class="team" id="t1Card">
              <div class="team-title" id="t1Title">Team 1</div>
              <div class="row">
                <input id="t1Name" type="text" value="Team 1" />
                <label class="legend">Color <input type="color" id="t1Color" value="#2563EB"></label>
              </div>
              <div class="score" id="t1Score">0</div>
              <div class="team-bar"><div class="fill" id="t1Bar" style="background:#2563EB"></div></div>
              <div class="legend" id="t1Streak">Streak: 0</div>
              <div class="grid" style="margin-top:6px">
                <button class="point" id="t1Plus">+1 (Correct)</button>
                <button class="point" id="t1Minus">-1 (Penalty)</button>
                <button class="point" id="t1Bonus" disabled>+2 BONUS</button>
              </div>
            </div>

            <!-- Team 2 -->
            <div class="team" id="t2Card">
              <div class="team-title" id="t2Title">Team 2</div>
              <div class="row">
                <input id="t2Name" type="text" value="Team 2" />
                <label class="legend">Color <input type="color" id="t2Color" value="#16A34A"></label>
              </div>
              <div class="score" id="t2Score">0</div>
              <div class="team-bar"><div class="fill" id="t2Bar" style="background:#16A34A"></div></div>
              <div class="legend" id="t2Streak">Streak: 0</div>
              <div class="grid" style="margin-top:6px">
                <button class="point" id="t2Plus">+1 (Correct)</button>
                <button class="point" id="t2Minus">-1 (Penalty)</button>
                <button class="point" id="t2Bonus" disabled>+2 BONUS</button>
              </div>
            </div>

            <!-- Team 3 (hidden unless selected) -->
            <div class="team hidden" id="t3Card">
              <div class="team-title" id="t3Title">Team 3</div>
              <div class="row">
                <input id="t3Name" type="text" value="Team 3" />
                <label class="legend">Color <input type="color" id="t3Color" value="#9333EA"></label>
              </div>
              <div class="score" id="t3Score">0</div>
              <div class="team-bar"><div class="fill" id="t3Bar" style="background:#9333EA"></div></div>
              <div class="legend" id="t3Streak">Streak: 0</div>
              <div class="grid" style="margin-top:6px">
                <button class="point" id="t3Plus">+1 (Correct)</button>
                <button class="point" id="t3Minus">-1 (Penalty)</button>
                <button class="point" id="t3Bonus" disabled>+2 BONUS</button>
              </div>
            </div>

            <div class="spacer"></div>
            <div class="games-card" style="min-width:280px">
              <div class="legend">Round & Game Results</div>
              <div id="banner" class="banner hidden">Round result will appear here.</div>
              <div class="card" style="padding:12px">
                <div class="big">Games Won</div>
                <div id="gamesTally" class="legend" style="margin-top:6px">—</div>
                <div id="gameLeader" class="legend" style="margin-top:6px">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Instructions + History -->
      <aside>
        <div class="card">
          <div class="row">
            <div><strong>Instructions</strong></div>
            <div class="spacer"></div>
            <button class="btn neutral" id="toggleInstr">Hide</button>
          </div>
          <div id="instrBody" style="margin-top:8px">
            <ul style="margin:0 0 6px 18px; padding:0">
              <li>Select <em>Direction</em>: English → Assyrian, Assyrian → English, or Both.</li>
              <li>Select <em>Type</em>: Free Response, Multiple Choice, or Mixed.</li>
              <li>Click <strong>Next Question</strong> to start. Timer begins automatically (except during Bonus).</li>
              <li><strong>Free Response</strong>: discuss as a class; the host reveals the answer and assigns points manually.</li>
              <li><strong>Multiple Choice</strong>: select your team, then choose an answer. Correct = +1 (or +2 in Bonus). Wrong = −1.</li>
              <li>Bonus rounds may include food items; be careful—choices are mixed to avoid easy tells.</li>
              <li>Use the <strong>History</strong> list to review any previous question and answer.</li>
            </ul>
            <div class="note">Show Answer unlocks after 10 seconds (Free). Multiple Choice options unlock after 10 seconds (score only if a team is selected).</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="row"><strong>History</strong><div class="spacer"></div><span class="legend" id="historyCount">0 items</span></div>
          <div class="history-list" id="historyList"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Confetti layer -->
  <div class="confetti" id="confetti"></div>

  <!-- Modal (Congrats / New Game) -->
  <div id="modalWrap" class="modal-backdrop hidden">
    <div class="modal">
      <h2 id="modalTitle">Congratulations!</h2>
      <p id="modalBody">Game winner goes here.</p>
      <p class="note" style="margin-top:10px">Please call over Mr. Sargool and show your results before clicking Next Question.</p>
      <div style="text-align:right; margin-top:12px">
        <button class="btn primary" id="modalClose">Continue</button>
      </div>
    </div>
  </div>

  <!-- Modal (History Viewer) -->
  <div id="historyModalWrap" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Review Question</h2>
      <div id="histMeta" class="muted" style="margin-bottom:8px"></div>
      <div id="histPrompt" class="prompt"></div>
      <div id="histFood" class="food"></div>
      <div id="histAnswer" class="answer"></div>
      <div id="histMC" class="mc"></div>
      <div style="text-align:right; margin-top:12px">
        <button class="btn neutral" id="historyClose">Close</button>
      </div>
    </div>
  </div>

<script>
/* ---------------- DATA ---------------- */
const PHRASES = {
  "I order (masc.)": "ܛܵܠܒܹܢ",
  "I will order (masc.)": "ܛܵܠܒܹܢ ܒܸܕ",
  "I order (fem.)": "ܛܵܠܒܵܢ",
  "I will order (fem.)": "ܛܵܠܒܵܢ ܒܸܕ",
  "you order (masc.)": "ܛܵܠܒܹܬ",
  "you will order (masc.)": "ܛܵܠܒܹܬ ܒܸܕ",
  "you order (fem.)": "ܛܵܠܒܵܬܝ",
  "you will order (fem.)": "ܛܵܠܒܵܬܝ ܒܸܕ",
  "he orders": "ܛܵܠܹܒ",
  "he will order": "ܛܵܠܹܒ ܒܸܕ",
  "she orders": "ܛܵܠܒܵܐ",
  "she will order": "ܛܵܠܒܵܐ ܒܸܕ",
  "we order": "ܛܵܠܒܲܚ",
  "we will order": "ܛܵܠܒܲܚ ܒܸܕ",
  "they order": "ܛܵܠܒܝܼ",
  "they will order": "ܛܵܠܒܝܼ ܒܸܕ",
  "y’all order": "ܛܵܠܒܝܼܬܘܿܢ",
  "y’all will order": "ܛܵܠܒܝܼܬܘܿܢ ܒܸܕ",
};

const PRONOUNS = {
  i_masc: "ܐܵܢܵܐ", i_fem: "ܐܵܢܵܐ",
  you_masc:"ܐܲܢ݇ܬ", you_fem:"ܐܲܢ݇ܬܝ",
  he:"ܗ̇ܘ", she:"ܗ̇ܝ",
  we:"ܐܲܚܢܲܢ", yall:"ܐܲܚܬܘܿܢ", they:"ܐܵܢܝܼ",
};

const FOODS_EN = ["potatoes","rice","beans","stew","kabobs","chicken","steak","lamb","fish","fries","water","fizzy drinks","yogurt drink","lemonade","orange juice","dolma","red rice","okra stew","yogurt","Assyrian egg rolls","tea","coffee","hummus","baba ganosh","salad","pickles","meatballs"];
const FOODS_SY = ["ܟܸܪܬܘܿܦܹ̈ܐ","ܪܸܙܵܐ","ܚܲܒ̣ܨܹ̈ܐ","ܫܘܼܪܒ̣ܵܐ","ܟܵܒܵܒܹ̈ܐ","ܟܬܵܝܬܵܐ","ܒܸܣܪܵܐ","ܥܸܪܒܵܐ","ܢܘܼܢܵܐ","ܟܸܪܬܘܿܦܹ̈ܐ ܩܸܠܝܹ̈ܐ","ܡܝܼܵܐ","ܫܬܵܝܬܵܐ ܒܲܩܒܸܩܵܢܵܐ","ܕܲܘܹ̈ܐ","ܡܝܼܵܐ ܕܠܝܼܡܘܿܢܹ̈ܐ","ܡܝܼܵܐ ܕܦܘܼܪ̈ܬܩܵܠܹܐ","ܕܘܿܠܡܵܐ","ܪܸܙܵܐ ܣܡܘܿܩܵܐ","ܒܲܡܝܹ̈ܐ","ܡܲܣܬܵܐ","ܒܘܼܪܲܟ","ܟ̰ܵܐܝ","ܩܲܗܘܵܐ","ܚܲܪ̈ܛܡܵܢܹܐ ܓܪ̈ܝܼܣܹܐ","ܒܵܕܸܡܓ̰ܵܢܹ̈ܐ ܓܪ̈ܝܼܣܹܐ","ܣܲܠܵܛܵܐ","ܛܘܼܪ̈ܫܝܹܐ","ܟܸܦܬܹ̈ܐ"];

/* ---------------- DOM ---------------- */
const timerLabel=document.getElementById('timerLabel');
const promptLabel=document.getElementById('promptLabel');
const foodLabel=document.getElementById('foodLabel');
const answerLabel=document.getElementById('answerLabel');
const mcWrap=document.getElementById('mcWrap');
const mcLock=document.getElementById('mcLock');
const teamLock=document.getElementById('teamLock');
const currentTeamPill=document.getElementById('currentTeamPill');

const nextBtn=document.getElementById('nextBtn');
const showAnswerBtn=document.getElementById('showAnswerBtn');

const timerSelect=document.getElementById('timerSelect');
const roundsSelect=document.getElementById('roundsSelect');
const dirSelect=document.getElementById('dirSelect');
const qtypeSelect=document.getElementById('qtypeSelect');
const playersSelect=document.getElementById('playersSelect');

const noRepeat=document.getElementById('noRepeat');
const fullscreenBtn=document.getElementById('fullscreenBtn');
const resetScoresBtn=document.getElementById('resetScoresBtn');
const resetGameBtn=document.getElementById('resetGameBtn');
const bonusPill=document.getElementById('bonusPill');
const endNote=document.getElementById('endNote');

const t1ScoreEl=document.getElementById('t1Score');
const t2ScoreEl=document.getElementById('t2Score');
const t3ScoreEl=document.getElementById('t3Score');
const t1Plus=document.getElementById('t1Plus');
const t1Minus=document.getElementById('t1Minus');
const t1Bonus=document.getElementById('t1Bonus');
const t2Plus=document.getElementById('t2Plus');
const t2Minus=document.getElementById('t2Minus');
const t2Bonus=document.getElementById('t2Bonus');
const t3Plus=document.getElementById('t3Plus');
const t3Minus=document.getElementById('t3Minus');
const t3Bonus=document.getElementById('t3Bonus');

const t1Color=document.getElementById('t1Color');
const t2Color=document.getElementById('t2Color');
const t3Color=document.getElementById('t3Color');
const t1Bar=document.getElementById('t1Bar');
const t2Bar=document.getElementById('t2Bar');
const t3Bar=document.getElementById('t3Bar');

const t1Card=document.getElementById('t1Card');
const t2Card=document.getElementById('t2Card');
const t3Card=document.getElementById('t3Card');

const t1Title=document.getElementById('t1Title');
const t2Title=document.getElementById('t2Title');
const t3Title=document.getElementById('t3Title');

const t1Name=document.getElementById('t1Name');
const t2Name=document.getElementById('t2Name');
const t3Name=document.getElementById('t3Name');

const t1StreakEl=document.getElementById('t1Streak');
const t2StreakEl=document.getElementById('t2Streak');
const t3StreakEl=document.getElementById('t3Streak');

const roundNowEl=document.getElementById('roundNow');
const roundTotalEl=document.getElementById('roundTotal');
const roundFillEl=document.getElementById('roundFill');
const banner=document.getElementById('banner');
const gamesTally=document.getElementById('gamesTally');
const gameLeader=document.getElementById('gameLeader');

const modalWrap=document.getElementById('modalWrap');
const modalTitle=document.getElementById('modalTitle');
const modalBody=document.getElementById('modalBody');
const modalClose=document.getElementById('modalClose');

const historyList=document.getElementById('historyList');
const historyCount=document.getElementById('historyCount');
const historyModalWrap=document.getElementById('historyModalWrap');
const histMeta=document.getElementById('histMeta');
const histPrompt=document.getElementById('histPrompt');
const histFood=document.getElementById('histFood');
const histAnswer=document.getElementById('histAnswer');
const histMC=document.getElementById('histMC');

const instructionsBtn=document.getElementById('instructionsBtn');
const toggleInstr=document.getElementById('toggleInstr');
const instrBody=document.getElementById('instrBody');

const confettiLayer=document.getElementById('confetti');

/* ---------------- State ---------------- */
let timerSeconds=30, currentTime=30, timerId=null, timerRunning=false;
let currentPromptKey='', isBonus=false, currentFoodIndex=null;
let directionMode='EN2SY';  // EN2SY | SY2EN | BOTH
let qtype='FREE';           // FREE | MC | MIXED
let players=2;              // 2 | 3
let score=[0,0,0,0];        // 1-indexed
let streak=[0,0,0,0];
let gamesWon=[0,0,0,0];
let totalRounds=10, currentRound=1;
let promptsPool=Object.keys(PHRASES), unusedPrompts=[...promptsPool];
let roundStartScores=[0,0,0,0];
let justFinishedGame=false;

/* Gating */
let canShowAnswer=false, answerUnlockTimeout=null;
let mcEnabled=false;
let lastRenderedDir='EN2SY';
let lastRenderedMode='FREE';
let selectedTeam=0;
let teamSelectable=true; // disabled in FREE

/* For MC options */
let mcOptions = []; // [{text, correct:boolean, button:HTMLElement}]

/* History (read-only snapshots) */
const history = []; // { round, dir, mode, isBonus, foodIdx, prompt, answerText, mcOptions:[{text,correct}] }
const MAX_HISTORY = 100;

/* ---------------- Utils ---------------- */
function hexToRgba(hex, alpha){
  const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if(!m) return `rgba(0,0,0,${alpha})`;
  const r=parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function teamName(i){ return (i===1?t1Name.value.trim():i===2?t2Name.value.trim():t3Name.value.trim()) || `Team ${i}`; }
function teamColor(i){ return i===1?t1Color.value:i===2?t2Color.value:t3Color.value; }
function tintPill(el, color){
  el.style.background = hexToRgba(color, 0.12);
  el.style.color = '#0F172A';
  el.style.borderColor = hexToRgba(color, 0.6);
}
function setActiveTeamHighlight(){
  [t1Card,t2Card,t3Card].forEach((el,idx)=>{
    if(!el) return;
    const i=idx+1;
    el.classList.toggle('active', teamSelectable && selectedTeam===i);
  });
  if(!teamSelectable || selectedTeam===0){
    currentTeamPill.classList.add('hidden');
    currentTeamPill.textContent='Current Team: —';
  }else{
    currentTeamPill.textContent = `Current Team: ${teamName(selectedTeam)}`;
    tintPill(currentTeamPill, teamColor(selectedTeam));
    currentTeamPill.classList.remove('hidden');
  }
}

/* Prompt helpers */
function randomPromptFromPool(){
  if(noRepeat.checked){
    if(unusedPrompts.length===0) unusedPrompts=[...promptsPool];
    const i=Math.floor(Math.random()*unusedPrompts.length);
    return unusedPrompts.splice(i,1)[0];
  }
  const keys=promptsPool;
  return keys[Math.floor(Math.random()*keys.length)];
}
function isFuture(key){ return key.toLowerCase().includes('will'); }
function detectPronounSyFromKey(key){
  const p=key.toLowerCase();
  if(p.startsWith('i ')) return p.includes('(fem')?PRONOUNS.i_fem:PRONOUNS.i_masc;
  if(p.startsWith('you ')) return p.includes('(fem')?PRONOUNS.you_fem:PRONOUNS.you_masc;
  if(p.startsWith('he ')) return PRONOUNS.he;
  if(p.startsWith('she ')) return PRONOUNS.she;
  if(p.startsWith('we ')) return PRONOUNS.we;
  if(p.startsWith('they ')) return PRONOUNS.they;
  if(p.startsWith('y’all')) return PRONOUNS.yall;
  return '';
}
function buildSyAnswerFromKey(key, foodIndex){
  const base=PHRASES[key]||'';
  const fut=isFuture(key);
  const pron=detectPronounSyFromKey(key);
  const verb=base.replace(/\s*ܒܸܕ\s*$/,'').trim();
  let out=fut?`${pron}  ܒܸܕ  ${verb}`:`${pron}  ${verb}`;
  if(foodIndex!=null) out+=`  ${FOODS_SY[foodIndex]}`;
  return out;
}
function englishPronounFromKey(key){
  if(key.toLowerCase().startsWith('y’all')) return "y’all";
  return key.split(' ')[0].replace('(masc.)','').replace('(fem.)','').trim();
}
function buildEnAnswerFromKey(key){
  const fut=isFuture(key);
  let pron=englishPronounFromKey(key);
  let base=fut?'will order':'orders';
  const p=pron.toLowerCase();
  if(!fut && (p==='i'||p==='we'||p==='they'||p==='y’all')) base='order';
  return `${pron} ${base}`;
}

/* Timer */
function updateTimerLabel(){ timerLabel.textContent=isBonus?'--':`${currentTime} sec`; }
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } timerRunning=false; }
function startTimer(){
  if(isBonus) return;
  stopTimer();
  timerRunning=true;
  timerId=setInterval(()=>{
    if(currentTime>0){
      currentTime--; updateTimerLabel();
      if(!canShowAnswer && currentTime<=timerSeconds-10){ unlockAfterDelay(); }
    } else { stopTimer(); }
  },1000);
}

/* Confetti */
function confettiBurst(colorA,colorB){
  const COUNT=80;
  for(let i=0;i<COUNT;i++){
    const d=document.createElement('div');
    d.className='piece';
    const x=Math.random()*100+'vw';
    const dx=(Math.random()*40-20)+'vw';
    d.style.setProperty('--x',x);
    d.style.setProperty('--dx',dx);
    d.style.left=Math.random()*100+'%';
    d.style.background=Math.random()<0.5?colorA:colorB;
    confettiLayer.appendChild(d);
    setTimeout(()=>d.remove(),1600);
  }
}

/* Scores / Streaks */
function renderScores(){
  t1ScoreEl.textContent=String(score[1]);
  t2ScoreEl.textContent=String(score[2]);
  if(players===3) t3ScoreEl.textContent=String(score[3]);
  const total=Math.max(1, score[1]+score[2]+(players===3?score[3]:0));
  t1Bar.style.width=(score[1]/total*100).toFixed(0)+'%';
  t2Bar.style.width=(score[2]/total*100).toFixed(0)+'%';
  t3Bar.style.width=(players===3?(score[3]/total*100).toFixed(0):'0')+'%';
}
function updateStreak(team,deltaPositive){
  streak[team]=deltaPositive?streak[team]+1:0;
  const el = team===1?t1StreakEl:team===2?t2StreakEl:t3StreakEl;
  el.textContent=`Streak: ${streak[team]}`;
  if(streak[team]>=3){
    score[team]+=1; streak[team]=0;
    el.textContent=`Streak: 0 (bonus applied)`;
    renderScores();
  }
}

/* Rounds / Games */
function setRounds(n){
  totalRounds=n;
  roundTotalEl.textContent=String(totalRounds);
  currentRound=1;
  roundNowEl.textContent=String(currentRound);
  roundFillEl.style.width=(currentRound-1)/Math.max(1,totalRounds)*100+'%';
  banner.classList.add('hidden');
  roundStartScores=[0, score[1], score[2], (players===3?score[3]:0)];
  endNote.classList.add('hidden');
  nextBtn.textContent='Next Question';
  justFinishedGame=false;
}
function finishRoundAndAdvance(){
  const d=[0, score[1]-roundStartScores[1], score[2]-roundStartScores[2], players===3?score[3]-roundStartScores[3]:-Infinity];
  let winTeam=0, maxDelta=-Infinity;
  [1,2].concat(players===3?[3]:[]).forEach(t=>{ if(d[t]>maxDelta){maxDelta=d[t]; winTeam=t;} });
  banner.textContent = (maxDelta<=0) ? 'Round tied' : `Round winner: ${teamName(winTeam)}`;
  banner.classList.remove('hidden');

  if(currentRound>=totalRounds){
    const vals=[1,2].concat(players===3?[3]:[]).map(t=>({t, s:score[t]}));
    const maxScore=Math.max(...vals.map(v=>v.s));
    const winners=vals.filter(v=>v.s===maxScore).map(v=>v.t);
    if(winners.length===1){
      gamesWon[winners[0]]++;
      modalTitle.textContent='Congratulations!';
      modalBody.textContent=`Game winner: ${teamName(winners[0])}`;
      modalWrap.classList.remove('hidden');
      confettiBurst(teamColor(winners[0]),'#ffffff');
    }else{
      modalTitle.textContent='Game Tied';
      modalBody.textContent='No game winner this time.';
      modalWrap.classList.remove('hidden');
    }
    updateGamesPanel();
    endNote.innerHTML='Please call over Mr. Sargool and show your results before clicking <strong>Next Question</strong>.<br>(Next game will begin and scores will be reset, but you can see the games counter below.)';
    endNote.classList.remove('hidden');
    nextBtn.textContent='Next Question (Next game will begin and scores will be reset …)';
    justFinishedGame=true;
  }

  if(currentRound<totalRounds){
    currentRound++;
    roundNowEl.textContent=String(currentRound);
    roundFillEl.style.width=((currentRound-1)/Math.max(1,totalRounds))*100+'%';
    roundStartScores=[0, score[1], score[2], (players===3?score[3]:0)];
  }
}
function updateGamesPanel(){
  const parts=[1,2].concat(players===3?[3]:[]).map(t=>`${teamName(t)}: ${gamesWon[t]}`);
  gamesTally.textContent=parts.join('  •  ');
  const maxVal=Math.max(...[1,2].concat(players===3?[3]:[]).map(t=>gamesWon[t]));
  const leaders=[1,2].concat(players===3?[3]:[]).filter(t=>gamesWon[t]===maxVal);
  gameLeader.textContent = (leaders.length>1) ? 'Games leader: tied' : `Games leader: ${teamName(leaders[0])}`;
}
function startNewGameHardReset(){
  score=[0,0,0,0]; streak=[0,0,0,0];
  t1StreakEl.textContent='Streak: 0'; t2StreakEl.textContent='Streak: 0'; if(players===3) t3StreakEl.textContent='Streak: 0';
  renderScores();
  currentRound=1; roundNowEl.textContent='1'; roundFillEl.style.width='0%';
  banner.classList.add('hidden'); endNote.classList.add('hidden'); modalWrap.classList.add('hidden');
  justFinishedGame=false;
  setRounds(parseInt(roundsSelect.value,10));
  initFirstQuestion(true);
}

/* Locks / gating */
function setTeamSelectable(on){
  teamSelectable = on;
  if(!on){ selectedTeam=0; }
  setActiveTeamHighlight();
}
function setupLocksForNewQuestion(){
  nextBtn.disabled=true;

  // FREE: disable team selection entirely; MC: enable it
  setTeamSelectable(lastRenderedMode !== 'FREE');

  // FREE: Show Answer is time-gated; MC: hidden
  showAnswerBtn.disabled = (lastRenderedMode==='FREE');

  canShowAnswer=false;
  mcEnabled=false;
  mcLock.classList.add('hidden');

  // Team prompt only meaningful in MC
  teamLock.classList.toggle('hidden', lastRenderedMode!=='MC');

  if(answerUnlockTimeout){ clearTimeout(answerUnlockTimeout); answerUnlockTimeout=null; }
  answerUnlockTimeout=setTimeout(unlockAfterDelay, 10000);

  if(lastRenderedMode==='FREE'){
    showAnswerBtn.classList.remove('hidden');
    answerLabel.classList.remove('hidden');
    mcWrap.classList.add('hidden');
    mcLock.classList.add('hidden');
    teamLock.classList.add('hidden'); // never show in FREE
  }else{
    showAnswerBtn.classList.add('hidden');
    answerLabel.classList.add('hidden');
    mcWrap.classList.remove('hidden');
    mcLock.classList.remove('hidden'); // show “10s” pill
    enableMCOptions(false);
  }
}
function unlockAfterDelay(){
  canShowAnswer=true;
  if(lastRenderedMode==='FREE'){
    showAnswerBtn.disabled=false;
    teamLock.classList.add('hidden');
  }else{
    maybeEnableMC();
    mcLock.classList.add('hidden');
  }
}
function maybeEnableMC(){
  const ready = canShowAnswer;
  enableMCOptions(ready);
  const showTeamNag = (lastRenderedMode==='MC') && canShowAnswer && (selectedTeam===0);
  teamLock.classList.toggle('hidden', !showTeamNag);
}

/* Multiple choice helpers (NO REPEATS) */
function uniqueFoodIndices(count, excludeIndex){
  const exclude = Array.isArray(excludeIndex) ? new Set(excludeIndex) :
                  (excludeIndex==null ? new Set() : new Set([excludeIndex]));
  const all=[...Array(FOODS_EN.length).keys()];
  const pool=all.filter(i=>!exclude.has(i));
  const picks=[];
  while(picks.length<count && pool.length){
    const idx=Math.floor(Math.random()*pool.length);
    picks.push(pool.splice(idx,1)[0]);
  }
  return picks;
}
function getUniqueDistractorKeys(correctKey, needed){
  const pool = Object.keys(PHRASES).filter(k=>k!==correctKey);
  const picks = new Set();
  while(picks.size < needed && pool.length){
    const k = pool.splice(Math.floor(Math.random()*pool.length),1)[0];
    picks.add(k);
  }
  return Array.from(picks);
}
function ensureUniqueOptionTexts(optionsBuilder){
  // Keeps calling optionsBuilder() until all 4 texts are unique (guarded attempts)
  for(let tries=0; tries<15; tries++){
    const opts = optionsBuilder();
    const texts = opts.map(o=>o.text);
    const uniq = new Set(texts);
    if(uniq.size === texts.length) return opts;
  }
  return optionsBuilder(); // fallback
}

/* MC renderers (with harder bonus mixing, no repeats) */
function renderMC_EN2SY(correctKey){
  const isBonusRound = isBonus && currentFoodIndex != null;
  const mode = isBonusRound ? (Math.random() < 0.5 ? 'ALL' : 'HALF') : 'NONE';

  const build = ()=>{
    const distractorKeys = getUniqueDistractorKeys(correctKey, 3);
    if (mode === 'ALL'){
      const otherFoods = uniqueFoodIndices(3, currentFoodIndex);
      return [
        { text: buildSyAnswerFromKey(correctKey, currentFoodIndex), correct:true },
        { text: buildSyAnswerFromKey(distractorKeys[0], otherFoods[0]), correct:false },
        { text: buildSyAnswerFromKey(distractorKeys[1], otherFoods[1]), correct:false },
        { text: buildSyAnswerFromKey(distractorKeys[2], otherFoods[2]), correct:false },
      ].sort(()=>Math.random()-0.5);
    } else if (mode === 'HALF'){
      const oneOtherFood = uniqueFoodIndices(1, currentFoodIndex)[0];
      return [
        { text: buildSyAnswerFromKey(correctKey, currentFoodIndex), correct:true },
        { text: buildSyAnswerFromKey(distractorKeys[0], oneOtherFood), correct:false },
        { text: buildSyAnswerFromKey(distractorKeys[1], null), correct:false },
        { text: buildSyAnswerFromKey(distractorKeys[2], null), correct:false },
      ].sort(()=>Math.random()-0.5);
    } else {
      return [
        { text: buildSyAnswerFromKey(correctKey, null), correct:true },
        { text: buildSyAnswerFromKey(distractorKeys[0], null), correct:false },
        { text: buildSyAnswerFromKey(distractorKeys[1], null), correct:false },
        { text: buildSyAnswerFromKey(distractorKeys[2], null), correct:false },
      ].sort(()=>Math.random()-0.5);
    }
  };

  const options = ensureUniqueOptionTexts(build);
  mcOptions = options;
  mcWrap.innerHTML='';
  options.forEach((opt, idx)=>{
    const btn=document.createElement('button');
    btn.className='opt';
    btn.textContent=opt.text;
    btn.onclick=()=>onMCClick(idx);
    opt.button = btn;
    mcWrap.appendChild(btn);
  });
  enableMCOptions(false);
}
function renderMC_SY2EN(correctKey){
  const distractorKeys = getUniqueDistractorKeys(correctKey, 3);

  const build = ()=>[
    { text: buildEnAnswerFromKey(correctKey), correct:true },
    { text: buildEnAnswerFromKey(distractorKeys[0]), correct:false },
    { text: buildEnAnswerFromKey(distractorKeys[1]), correct:false },
    { text: buildEnAnswerFromKey(distractorKeys[2]), correct:false },
  ].sort(()=>Math.random()-0.5);

  const options = ensureUniqueOptionTexts(build);
  mcOptions = options;
  mcWrap.innerHTML='';
  options.forEach((opt, idx)=>{
    const btn=document.createElement('button');
    btn.className='opt';
    btn.textContent=opt.text;
    btn.onclick=()=>onMCClick(idx);
    opt.button = btn;
    mcWrap.appendChild(btn);
  });
  enableMCOptions(false);
}
function enableMCOptions(on){
  mcEnabled=on;
  mcOptions.forEach(opt=>{
    opt.button.classList.toggle('enabled', on);
    opt.button.style.cursor = on ? 'pointer' : 'not-allowed';
  });
}
function pulseTeamCards(){
  [t1Card, t2Card, players===3 ? t3Card : null].filter(Boolean).forEach(el=>{
    el.style.transition='transform 120ms';
    el.style.transform='scale(1.02)';
    setTimeout(()=>{ el.style.transform='scale(1)'; }, 140);
  });
}
function onMCClick(idx){
  if(!mcEnabled) return;
  stopTimer();

  mcOptions.forEach(opt => { if (opt.correct) opt.button.classList.add('correct'); });
  if (!mcOptions[idx].correct) mcOptions[idx].button.classList.add('wrong');

  enableMCOptions(false);
  mcEnabled=false;

  if(!teamSelectable || selectedTeam===0){
    teamLock.classList.remove('hidden');
    pulseTeamCards();
    nextBtn.disabled=false;
    return;
  }

  const deltaCorrect = isBonus ? 2 : 1;
  if (mcOptions[idx].correct) {
    score[selectedTeam]=Math.max(0, score[selectedTeam] + deltaCorrect);
    updateStreak(selectedTeam, true);
    confettiBurst(teamColor(selectedTeam),'#ffffff');
  } else {
    score[selectedTeam]=Math.max(0, score[selectedTeam] - 1);
    updateStreak(selectedTeam, false);
  }
  renderScores();

  nextBtn.disabled=false;
}

/* History */
function pushHistorySnapshot(){
  const snapshot = {
    round: currentRound,
    dir: lastRenderedDir,
    mode: lastRenderedMode,
    isBonus: isBonus,
    foodIdx: currentFoodIndex,
    prompt: promptLabel.textContent,
    answerText: (lastRenderedDir==='EN2SY'
      ? buildSyAnswerFromKey(currentPromptKey, currentFoodIndex)
      : buildEnAnswerFromKey(currentPromptKey)),
    mcOptions: mcOptions.map(o=>({text:o.text, correct:o.correct})),
  };
  history.push(snapshot);
  if(history.length>MAX_HISTORY) history.shift();
  renderHistoryList();
}
function renderHistoryList(){
  historyCount.textContent = `${history.length} item${history.length===1?'':'s'}`;
  historyList.innerHTML='';
  history.forEach((h, i)=>{
    const row=document.createElement('div');
    row.className='history-item';
    const left=document.createElement('div');
    left.innerHTML = `<div><strong>Q${i+1}</strong> • Round ${h.round} • ${h.dir} • ${h.mode}${h.isBonus?' • Bonus':''}</div>
                      <div class="meta">${h.prompt}</div>`;
    const right=document.createElement('div');
    const btn=document.createElement('button');
    btn.className='btn neutral';
    btn.textContent='View';
    btn.onclick=()=>openHistoryModal(h);
    right.appendChild(btn);
    row.appendChild(left); row.appendChild(right);
    historyList.appendChild(row);
  });
}
function openHistoryModal(h){
  histMeta.textContent = `Round ${h.round} • ${h.dir} • ${h.mode}${h.isBonus?' • Bonus':''}`;
  histPrompt.textContent = h.prompt;
  histFood.textContent = (h.isBonus && h.foodIdx!=null) ? `Bonus Food: ${FOODS_EN[h.foodIdx]}` : '';
  histAnswer.textContent = h.answerText;
  histMC.innerHTML='';
  if(h.mode==='MC' && h.mcOptions.length){
    h.mcOptions.forEach(o=>{
      const div=document.createElement('div');
      div.className='opt ' + (o.correct ? 'correct':'wrong');
      div.textContent = o.text;
      histMC.appendChild(div);
    });
  }
  historyModalWrap.classList.remove('hidden');
}

/* Flow */
function chooseActualMode(){
  if(qtype==='MIXED'){
    return Math.random()<0.5 ? 'FREE' : 'MC';
  }
  return qtype;
}
function nextQuestion(){
  if(!modalWrap.classList.contains('hidden')) return;
  if(justFinishedGame){ startNewGameHardReset(); return; }

  // Save the just-finished question to history (if any was onscreen)
  if(promptLabel.textContent){
    pushHistorySnapshot();
  }

  finishRoundAndAdvance();

  currentTime=timerSeconds; updateTimerLabel();
  answerLabel.textContent='';
  mcWrap.innerHTML=''; mcOptions=[];

  directionMode=document.getElementById('dirSelect').value;
  const dir = (directionMode==='BOTH') ? (Math.random()<0.5?'EN2SY':'SY2EN') : directionMode;
  lastRenderedDir = dir;

  qtype = document.getElementById('qtypeSelect').value;
  lastRenderedMode = chooseActualMode();

  // BONUS selection BEFORE rendering
  if(Math.random()<0.20){
    currentFoodIndex=Math.floor(Math.random()*FOODS_EN.length);
    foodLabel.textContent=`Bonus Round: ${FOODS_EN[currentFoodIndex]}`;
    bonusPill.classList.remove('hidden');
    isBonus=true;
    stopTimer();
  }else{
    currentFoodIndex=null; foodLabel.textContent='';
    bonusPill.classList.add('hidden');
    isBonus=false;
  }

  // Setup locks for this question
  setupLocksForNewQuestion();

  // New prompt
  currentPromptKey=randomPromptFromPool();

  if(dir==='EN2SY'){
    promptLabel.textContent = currentPromptKey;
    if(lastRenderedMode==='FREE'){
      answerLabel.textContent='';
      if(!isBonus) startTimer();
    }else{
      renderMC_EN2SY(currentPromptKey);
      if(!isBonus) startTimer();
    }
  }else{
    const promptSY = buildSyAnswerFromKey(currentPromptKey, currentFoodIndex);
    promptLabel.textContent = promptSY;
    if(lastRenderedMode==='FREE'){
      answerLabel.textContent='';
      if(!isBonus) startTimer();
    }else{
      renderMC_SY2EN(currentPromptKey);
      if(!isBonus) startTimer();
    }
  }
}

function showAnswer(){
  if(lastRenderedMode!=='FREE') return;
  if(!canShowAnswer) return;
  stopTimer();
  if(lastRenderedDir==='EN2SY'){
    answerLabel.textContent = buildSyAnswerFromKey(currentPromptKey, currentFoodIndex);
  }else{
    answerLabel.textContent = buildEnAnswerFromKey(currentPromptKey);
  }
  nextBtn.disabled=false;
}

/* Buttons */
function addPoints(team,delta){
  score[team]=Math.max(0,score[team]+delta);
  renderScores();
  updateStreak(team, delta>0);
}
function addBonus(team){
  if(!isBonus) return;
  addPoints(team,2);
  confettiBurst(teamColor(team),'#ffffff');
}
t1Plus.onclick=()=>addPoints(1,1);
t1Minus.onclick=()=>addPoints(1,-1);
t1Bonus.onclick=()=>addBonus(1);
t2Plus.onclick=()=>addPoints(2,1);
t2Minus.onclick=()=>addPoints(2,-1);
t2Bonus.onclick=()=>addBonus(2);
if(t3Plus) t3Plus.onclick=()=>addPoints(3,1);
if(t3Minus) t3Minus.onclick=()=>addPoints(3,-1);
if(t3Bonus) t3Bonus.onclick=()=>addBonus(3);

resetScoresBtn.onclick=()=>{ score=[0,0,0,0]; streak=[0,0,0,0]; t1StreakEl.textContent='Streak: 0'; t2StreakEl.textContent='Streak: 0'; if(players===3) t3StreakEl.textContent='Streak: 0'; renderScores(); banner.classList.add('hidden'); roundStartScores=[0,score[1],score[2],(players===3?score[3]:0)]; };
resetGameBtn.onclick=startNewGameHardReset;

showAnswerBtn.onclick=showAnswer;
nextBtn.onclick=nextQuestion;

/* Selects */
timerSelect.onchange=(e)=>{ timerSeconds=parseInt(e.target.value,10); currentTime=timerSeconds; updateTimerLabel(); };
roundsSelect.onchange=(e)=>{ setRounds(parseInt(e.target.value,10)); };
qtypeSelect.onchange=()=>{};
dirSelect.onchange=()=>{};
playersSelect.onchange=()=>{
  players = parseInt(playersSelect.value,10);
  const t3Visible = (players===3);
  t3Card.classList.toggle('hidden', !t3Visible);
  if(!t3Visible && selectedTeam===3) selectedTeam=0;
  setActiveTeamHighlight();
  renderScores(); updateGamesPanel();
};

/* Team selection (ignored in FREE) */
[t1Card, t2Card, t3Card].forEach((el,idx)=>{
  if(!el) return;
  const team=idx+1;
  el.onclick=()=>{
    if(!teamSelectable) return;
    if(team===3 && players!==3) return;
    selectedTeam = team;
    setActiveTeamHighlight();
    if(lastRenderedMode==='MC') maybeEnableMC();
  };
});

/* Team live updates */
function updateTeamTitle(which){
  const nm=teamName(which);
  (which===1? t1Title : which===2? t2Title : t3Title).textContent=nm;
  if(selectedTeam===which) setActiveTeamHighlight();
  updateGamesPanel();
}
t1Name.addEventListener('input', ()=>updateTeamTitle(1));
t2Name.addEventListener('input', ()=>updateTeamTitle(2));
t3Name.addEventListener('input', ()=>updateTeamTitle(3));

function applyTeamColor(which){
  const color=teamColor(which);
  const card=which===1? t1Card : which===2? t2Card : t3Card;
  const bar=which===1? t1Bar : which===2? t2Bar : t3Bar;
  card.style.background=hexToRgba(color,0.10);
  card.style.borderColor=hexToRgba(color,0.6);
  bar.style.background=color;
  if(teamSelectable && selectedTeam===which) tintPill(currentTeamPill,color);
}
[t1Color,t2Color,t3Color].forEach((el,i)=>{ if(el) el.oninput=()=>applyTeamColor(i+1); });

/* Instructions toggle */
instructionsBtn.onclick=()=>{ instrBody.classList.toggle('hidden'); };
toggleInstr.onclick=()=>{ 
  const hide = !instrBody.classList.contains('hidden');
  instrBody.classList.toggle('hidden', hide);
  toggleInstr.textContent = hide ? 'Show' : 'Hide';
};

/* Fullscreen */
fullscreenBtn.onclick=()=>{
  const el=document.documentElement;
  if(!document.fullscreenElement){ el.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
};

/* Modals */
modalClose.onclick=()=>{ modalWrap.classList.add('hidden'); justFinishedGame=true; };
document.getElementById('historyClose').onclick=()=>{ historyModalWrap.classList.add('hidden'); };

/* Keyboard shortcuts */
document.addEventListener('keydown',(e)=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT'||e.target.isContentEditable) return;
  if(e.key===' '){ e.preventDefault(); if(isBonus){ return; } if(timerRunning){ stopTimer(); } else { startTimer(); } }
  if(e.key==='Enter'){ e.preventDefault(); if(!nextBtn.disabled) nextQuestion(); }
  if(e.key.toLowerCase()==='a'){ e.preventDefault(); if(lastRenderedMode==='FREE' && canShowAnswer) showAnswer(); }
});

/* Init */
function initFirstQuestion(forceFresh=false){
  timerSeconds=parseInt(timerSelect.value,10);
  currentTime=timerSeconds;
  totalRounds=parseInt(roundsSelect.value,10);
  roundTotalEl.textContent=String(totalRounds);
  if(forceFresh){ currentRound=1; roundNowEl.textContent='1'; roundFillEl.style.width='0%'; }
  renderScores(); updateGamesPanel(); updateTimerLabel();

  const directionModeInit=dirSelect.value;
  const qtypeInit=qtypeSelect.value;
  lastRenderedDir = (directionModeInit==='BOTH') ? (Math.random()<0.5?'EN2SY':'SY2EN') : directionModeInit;
  lastRenderedMode = (qtypeInit==='MIXED') ? (Math.random()<0.5?'FREE':'MC') : qtypeInit;

  isBonus=false; currentFoodIndex=null; foodLabel.textContent=''; bonusPill.classList.add('hidden');

  setupLocksForNewQuestion();

  currentPromptKey=randomPromptFromPool();
  if(lastRenderedDir==='EN2SY'){
    promptLabel.textContent=currentPromptKey;
    if(lastRenderedMode==='MC'){ renderMC_EN2SY(currentPromptKey); }
  }else{
    promptLabel.textContent=buildSyAnswerFromKey(currentPromptKey, currentFoodIndex);
    if(lastRenderedMode==='MC'){ renderMC_SY2EN(currentPromptKey); }
  }

  startTimer();
}

(function init(){
  applyTeamColor(1); applyTeamColor(2); applyTeamColor(3);
  updateTeamTitle(1); updateTeamTitle(2); updateTeamTitle(3);
  initFirstQuestion();
})();
</script>
</body>
</html>
