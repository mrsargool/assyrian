<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Assyrian III: Verb to Order Game</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Syriac+Eastern:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#F7F9FC; --card:#FFFFFF; --ink:#0F172A; --muted:#475569; --line:#E5E7EB;
    --accent:#2563EB; --success:#16A34A; --warn:#D97706; --danger:#DC2626; --active:#0ea5e9; --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 "Segoe UI",system-ui,Arial,sans-serif}
  .wrap{max-width:1240px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{font-size:22px;margin:0;font-weight:800}
  .controls{display:flex;flex-wrap:wrap;align-items:center;gap:8px}
  select,input[type="text"],input[type="number"]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink)}
  .btn{appearance:none;border:0;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent)} .btn.success{background:var(--success)}
  .btn.neutral{background:#334155} .btn.danger{background:var(--danger)} .btn.warn{background:var(--warn)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#EEF2FF;color:#3730A3;font-weight:800;font-size:13px;border:1px solid var(--line)}

  .grid2{display:grid;grid-template-columns:1fr 320px;gap:16px}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.04);border:1px solid var(--line)}
  .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
  .spacer{flex:1} .legend{color:var(--muted);font-size:12px}

  /* Stage (centered timer/prompt/answer) */
  .stage{text-align:center}
  .timer{font-size:56px;font-weight:800;color:var(--accent);margin:8px 0}
  .prompt{font-size:30px;font-weight:800;margin:8px 0 6px}
  .food{font-size:18px;font-style:italic;color:var(--warn);margin:0 0 6px}
  .answer{font-family:"Noto Sans Syriac Eastern","Segoe UI",system-ui,Arial,sans-serif;font-size:48px;color:var(--success);margin:12px 0 18px}

  /* Progress */
  .roundbar{height:8px;background:#E5E7EB;border-radius:8px;overflow:hidden}
  .roundbar .fill{height:100%;width:0%;background:var(--accent);transition:width .4s ease}
  .banner{margin:10px 0;padding:10px 14px;border-radius:10px;background:#ECFDF5;color:#065F46;border:1px solid #A7F3D0;font-weight:700}
  .hidden{display:none!important}

  /* Multiple choice */
  .mc{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;justify-content:center}
  .mc .opt{flex:1 1 46%;max-width:480px;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:not-allowed}
  .mc .opt.enabled{cursor:pointer;background:#F8FAFC}
  .mc .opt.correct{border-color:#16A34A;background:#ECFDF5}
  .mc .opt.wrong{border-color:#DC2626;background:#FEF2F2}

  /* Teams (kept compact and visible) */
  .scores .team{flex:1 1 0;min-width:280px;border-radius:16px;padding:14px;border:2px solid var(--line);background:#fff;transition:.2s;cursor:pointer;position:relative}
  .scores .team:hover{box-shadow:0 0 0 3px rgba(14,165,233,.12)}
  .scores .team.active{box-shadow:0 0 0 3px rgba(14,165,233,.35);border-color:var(--active)}
  .scores .team.active::after{content:"Selected";position:absolute;top:10px;right:12px;background:#0ea5e9;color:#fff;font-size:11px;font-weight:800;padding:2px 8px;border-radius:999px}
  .team-title{font-size:18px;font-weight:800;margin-bottom:6px}
  .score{font-size:26px;font-weight:800;margin:6px 0}
  .team-bar{height:6px;border-radius:6px;background:#E5E7EB;overflow:hidden;margin-top:6px}
  .team-bar .fill{height:100%;width:0%;transition:width .3s ease}
  .grid{display:flex;gap:6px;flex-wrap:wrap}
  .point{padding:8px 10px;border-radius:10px;background:#E2E8F0;color:var(--ink);font-weight:800;border:1px solid #CBD5E1;cursor:pointer}
  .point:hover{background:#CBD5E1}
  .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#F1F5F9}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border-radius:16px;padding:20px;max-width:760px;width:92%;border:1px solid var(--line);text-align:left}
  .modal h2{margin:6px 0 10px;font-size:22px}
  .note{font-size:12px;color:var(--muted)}
  .teacher-on{outline:3px solid #f59e0b;outline-offset:3px;border-radius:10px;padding:2px 6px;background:#FFFBEB;color:#92400E;font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Assyrian III: Verb to Order Game</h1>
    <div class="controls">
      <button class="btn neutral" id="fullscreenBtn">Fullscreen</button>

      <label class="legend">Timer:</label>
      <select id="timerSelect"><option>20</option><option selected>30</option><option>45</option><option>60</option></select>

      <label class="legend">Rounds:</label>
      <select id="roundsSelect"><option>5</option><option selected>10</option><option>15</option><option>20</option></select>

      <label class="legend"><input type="checkbox" id="noRepeat" checked> No-repeat</label>

      <label class="legend">Direction:</label>
      <select id="dirSelect">
        <option value="EN2SY" selected>English → Assyrian</option>
        <option value="SY2EN">Assyrian → English</option>
        <option value="BOTH">Both</option>
      </select>

      <label class="legend">Type:</label>
      <select id="qtypeSelect">
        <option value="FREE" selected>Free Response</option>
        <option value="MC">Multiple Choice</option>
        <option value="MIXED">Mixed</option>
      </select>

      <label class="legend">Players:</label>
      <select id="playersSelect">
        <option value="2" selected>2 Players</option>
        <option value="3">3 Players</option>
      </select>

      <button class="btn warn" id="resetGameBtn">Reset Game</button>
      <button class="btn danger" id="resetScoresBtn">Reset Scores</button>
      <button class="btn primary" id="instructionsBtn">Instructions</button>

      <!-- Online -->
      <button class="btn primary" id="createGameBtn">Create Online Game</button>
      <button class="btn neutral" id="joinGameBtn">Join Online Game</button>
      <span id="onlineInfo" class="pill hidden">Offline</span>

      <!-- Teacher -->
      <button class="btn neutral" id="teacherBtn">Teacher</button>
      <span id="teacherBadge" class="hidden teacher-on">Teacher Mode</span>
    </div>
  </header>

  <div class="grid2">
    <div>
      <div class="card stage" style="margin-bottom:10px">
        <div class="row" style="justify-content:center">
          <div><strong>Round:</strong> <span id="roundNow">1</span>/<span id="roundTotal">10</span></div>
          <div class="spacer"></div>
          <div style="min-width:280px">
            <div class="roundbar"><div class="fill" id="roundFill"></div></div>
          </div>
        </div>
        <div id="endNote" class="note hidden" style="margin-top:8px;"></div>
      </div>

      <div class="card stage">
        <div class="timer" id="timerLabel">30 sec</div>
        <div id="currentTeamPill" class="pill hidden" style="margin-bottom:8px">Current Team: —</div>

        <div class="prompt" id="promptLabel"></div>
        <div class="food" id="foodLabel"></div>
        <div class="answer" id="answerLabel"></div>

        <div class="mc hidden" id="mcWrap"></div>

        <div style="margin-top:10px">
          <button class="btn success" id="showAnswerBtn" disabled>Show Answer</button>
          <button class="btn primary" id="nextBtn" disabled>Next Question</button>
          <span id="bonusPill" class="pill hidden" style="margin-left:8px">BONUS ROUND (45s)</span>
        </div>
        <div class="note" style="margin-top:8px">MC: answer first or select team first — either order works. Show Answer / MC unlock after 10s (Teacher Mode bypasses).</div>
      </div>

      <!-- Teams row stays visible without scrolling -->
      <div class="card scores" style="margin-top:14px">
        <div class="row" style="align-items:flex-start">
          <!-- Team 1 -->
          <div class="team" id="t1Card">
            <div class="team-title" id="t1Title">Team 1</div>
            <div class="row">
              <input id="t1Name" type="text" value="Team 1" />
              <label class="legend">Color <input type="color" id="t1Color" value="#2563EB"></label>
            </div>
            <div class="score" id="t1Score">0</div>
            <div class="team-bar"><div class="fill" id="t1Bar" style="background:#2563EB"></div></div>
            <div class="legend" id="t1Streak">Streak: 0</div>

            <!-- Per-team Bonus + Power-up (+5s only) -->
            <div class="grid" style="margin-top:6px">
              <button class="point" id="t1PUTime">+5 sec (0)</button>
              <button class="point" id="t1BonusCredit" disabled>Activate Bonus (0)</button>
            </div>

            <!-- Manual points -->
            <div class="grid" style="margin-top:6px">
              <button class="point" id="t1Plus">+1</button>
              <button class="point" id="t1Minus">-1</button>
            </div>

            <div class="badges" id="t1Badges"></div>
          </div>

          <!-- Team 2 -->
          <div class="team" id="t2Card">
            <div class="team-title" id="t2Title">Team 2</div>
            <div class="row">
              <input id="t2Name" type="text" value="Team 2" />
              <label class="legend">Color <input type="color" id="t2Color" value="#16A34A"></label>
            </div>
            <div class="score" id="t2Score">0</div>
            <div class="team-bar"><div class="fill" id="t2Bar" style="background:#16A34A"></div></div>
            <div class="legend" id="t2Streak">Streak: 0</div>

            <div class="grid" style="margin-top:6px">
              <button class="point" id="t2PUTime">+5 sec (0)</button>
              <button class="point" id="t2BonusCredit" disabled>Activate Bonus (0)</button>
            </div>

            <div class="grid" style="margin-top:6px">
              <button class="point" id="t2Plus">+1</button>
              <button class="point" id="t2Minus">-1</button>
            </div>

            <div class="badges" id="t2Badges"></div>
          </div>

          <!-- Team 3 -->
          <div class="team hidden" id="t3Card">
            <div class="team-title" id="t3Title">Team 3</div>
            <div class="row">
              <input id="t3Name" type="text" value="Team 3" />
              <label class="legend">Color <input type="color" id="t3Color" value="#9333EA"></label>
            </div>
            <div class="score" id="t3Score">0</div>
            <div class="team-bar"><div class="fill" id="t3Bar" style="background:#9333EA"></div></div>
            <div class="legend" id="t3Streak">Streak: 0</div>

            <div class="grid" style="margin-top:6px">
              <button class="point" id="t3PUTime">+5 sec (0)</button>
              <button class="point" id="t3BonusCredit" disabled>Activate Bonus (0)</button>
            </div>

            <div class="grid" style="margin-top:6px">
              <button class="point" id="t3Plus">+1</button>
              <button class="point" id="t3Minus">-1</button>
            </div>

            <div class="badges" id="t3Badges"></div>
          </div>

          <!-- Games/Stats (compact) -->
          <div class="spacer"></div>
          <div style="min-width:300px">
            <div class="legend">Round & Game Results</div>
            <div id="banner" class="banner hidden">—</div>

            <div class="card" style="margin-top:8px;padding:12px">
              <div style="font-weight:800">Games Won</div>
              <div id="gamesTally" class="legend" style="margin-top:6px">—</div>
              <div id="gameLeader" class="legend" style="margin-top:6px">—</div>
            </div>

            <div class="card" style="margin-top:8px;padding:12px">
              <div style="font-weight:800">Stats</div>
              <div id="statsBox" class="legend" style="margin-top:6px">—</div>
              <div class="row" style="margin-top:8px">
                <button class="btn neutral" id="exportCsvBtn">Export CSV</button>
                <button class="btn danger" id="clearHistoryBtn">Clear History</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Right: Instructions + History -->
    <aside>
      <div class="card">
        <div class="row">
          <div><strong>Instructions</strong></div>
          <div class="spacer"></div>
          <button class="btn neutral" id="toggleInstr">Hide</button>
        </div>
        <div id="instrBody" style="margin-top:8px">
          <ul style="margin:0 0 6px 18px;padding:0">
            <li>Choose Direction (EN→SY / SY→EN / Both) and Type (Free / MC / Mixed).</li>
            <li>Click <strong>Next Question</strong> to start. Timer auto-starts (bonus = 45s).</li>
            <li><strong>Free Response</strong>: host reveals answer; assign points manually.</li>
            <li><strong>Multiple Choice</strong>: answer first <em>or</em> select your team first — either order works. If you answered before picking a team, select your team afterward to award/deduct points.</li>
            <li><strong>Bonus</strong>: each team can activate bonus for the <em>next question</em> using their credits. All bonus rounds are 45s; unlock at 10s unless Teacher Mode is on.</li>
            <li><strong>Teacher Mode</strong>: disables 10-second unlock (password: mrsargool).</li>
            <li><strong>Online</strong>: Create/Join Online Game to play from multiple Chromebooks.</li>
          </ul>
          <div class="note">History → Stats → Export CSV available at any time.</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row">
          <strong>History</strong><div class="spacer"></div><span class="legend" id="historyCount">0 items</span>
        </div>
        <div class="history-list" id="historyList" style="max-height:360px;overflow:auto;margin-top:8px"></div>
      </div>
    </aside>
  </div>
</div>

<!-- Winner Modal -->
<div id="modalWrap" class="modal-backdrop hidden">
  <div class="modal">
    <h2 id="modalTitle">Congratulations!</h2>
    <p id="modalBody">Game winner goes here.</p>
    <p class="note" style="margin-top:10px">Please call over Mr. Sargool and show your results before clicking Next Question.</p>
    <div style="text-align:right;margin-top:12px">
      <button class="btn primary" id="modalClose">Continue</button>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="historyModalWrap" class="modal-backdrop hidden">
  <div class="modal">
    <h2>Review Question</h2>
    <div id="histMeta" class="note" style="margin-bottom:8px"></div>
    <div id="histPrompt" class="prompt"></div>
    <div id="histFood" class="food"></div>
    <div id="histAnswer" class="answer"></div>
    <div id="histMC" class="mc"></div>
    <div style="text-align:right;margin-top:12px">
      <button class="btn neutral" id="historyClose">Close</button>
    </div>
  </div>
</div>

<!-- STEP 3: Paste your Firebase config here (remove the /* */ to enable) -->
<script type="module" id="firebase-config">
  
export const firebaseConfig = {
  apiKey: "AIzaSyBPHRt-A17lXnzEDghxQDdXOjdHgkOjpo8",
  authDomain: "verb-to-order-86170.firebaseapp.com",
  projectId: "verb-to-order-86170",
  storageBucket: "verb-to-order-86170.appspot.com",
  messagingSenderId: "701246321735",
  appId: "1:701246321735:web:882917e49b14bfa4c7ad62"
};

</script>

<script type="module">
/* ================= PHRASES / FOODS ================= */
const PHRASES = {
  "I order (masc.)":"ܛܵܠܒܹܢ","I will order (masc.)":"ܛܵܠܒܹܢ ܒܸܕ","I order (fem.)":"ܛܵܠܒܵܢ","I will order (fem.)":"ܛܵܠܒܵܢ ܒܸܕ",
  "you order (masc.)":"ܛܵܠܒܹܬ","you will order (masc.)":"ܛܵܠܒܹܬ ܒܸܕ","you order (fem.)":"ܛܵܠܒܵܬܝ","you will order (fem.)":"ܛܵܠܒܵܬܝ ܒܸܕ",
  "he orders":"ܛܵܠܹܒ","he will order":"ܛܵܠܹܒ ܒܸܕ","she orders":"ܛܵܠܒܵܐ","she will order":"ܛܵܠܒܵܐ ܒܸܕ",
  "we order":"ܛܵܠܒܲܚ","we will order":"ܛܵܠܒܲܚ ܒܸܕ","they order":"ܛܵܠܒܝܼ","they will order":"ܛܵܠܒܝܼ ܒܸܕ",
  "y’all order":"ܛܵܠܒܝܼܬܘܿܢ","y’all will order":"ܛܵܠܒܝܼܬܘܿܢ ܒܸܕ",
};
const PRONOUNS = { i_masc:"ܐܵܢܵܐ", i_fem:"ܐܵܢܵܐ", you_masc:"ܐܲܢ݇ܬ", you_fem:"ܐܲܢ݇ܬܝ", he:"ܗ̇ܘ", she:"ܗ̇ܝ", we:"ܐܲܚܢܲܢ", yall:"ܐܲܚܬܘܿܢ", they:"ܐܵܢܝܼ" };
const FOODS_EN = ["potatoes","rice","beans","stew","kabobs","chicken","steak","lamb","fish","fries","water","fizzy drinks","yogurt drink","lemonade","orange juice","dolma","red rice","okra stew","yogurt","Assyrian egg rolls","tea","coffee","hummus","baba ganosh","salad","pickles","meatballs"];
const FOODS_SY = ["ܟܸܪܬܘܿܦܹ̈ܐ","ܪܸܙܵܐ","ܚܲܒ̣ܨܹ̈ܐ","ܫܘܼܪܒ̣ܵܐ","ܟܵܒܵܒܹ̈ܐ","ܟܬܵܝܬܵܐ","ܒܸܣܪܵܐ","ܥܸܪܒܵܐ","ܢܘܼܢܵܐ","ܟܸܪܬܘܿܦܹ̈ܐ ܩܸܠܝܹ̈ܐ","ܡܝܼܵܐ","ܫܬܵܝܬܵܐ ܒܲܩܒܸܩܵܢܵܐ","ܕܲܘܹ̈ܐ","ܡܝܼܵܐ ܕܠܝܼܡܘܿܢܹ̈ܐ","ܡܝܼܵܐ ܕܦܘܼܪ̈ܬܩܵܠܹܐ","ܕܘܿܠܡܵܐ","ܪܸܙܵܐ ܣܡܘܿܩܵܐ","ܒܲܡܝܹ̈ܐ","ܡܲܣܬܵܐ","ܒܘܼܪܲܟ","ܟ̰ܵܐܝ","ܩܲܗܘܵܐ","ܚܲܪ̈ܛܡܵܢܹܐ ܓܪ̈ܝܼܣܹܐ","ܒܵܕܸܡܓ̰ܵܢܹ̈ܐ ܓܪ̈ܝܼܣܹܐ","ܣܲܠܵܛܵܐ","ܛܘܼܪ̈ܫܝܹܐ","ܟܸܦܬܹ̈ܐ"];

/* ================= DOM HOOKS ================= */
const el = (id)=>document.getElementById(id);
const timerLabel=el('timerLabel'), promptLabel=el('promptLabel'), foodLabel=el('foodLabel'), answerLabel=el('answerLabel');
const mcWrap=el('mcWrap'), nextBtn=el('nextBtn'), showAnswerBtn=el('showAnswerBtn'), bonusPill=el('bonusPill');
const timerSelect=el('timerSelect'), roundsSelect=el('roundsSelect'), dirSelect=el('dirSelect'), qtypeSelect=el('qtypeSelect'), playersSelect=el('playersSelect');
const t1Card=el('t1Card'), t2Card=el('t2Card'), t3Card=el('t3Card');
const t1Name=el('t1Name'), t2Name=el('t2Name'), t3Name=el('t3Name'), t1Title=el('t1Title'), t2Title=el('t2Title'), t3Title=el('t3Title');
const t1Color=el('t1Color'), t2Color=el('t2Color'), t3Color=el('t3Color'), t1Bar=el('t1Bar'), t2Bar=el('t2Bar'), t3Bar=el('t3Bar');
const t1ScoreEl=el('t1Score'), t2ScoreEl=el('t2Score'), t3ScoreEl=el('t3Score');
const t1StreakEl=el('t1Streak'), t2StreakEl=el('t2Streak'), t3StreakEl=el('t3Streak');
const t1PUTime=el('t1PUTime'), t2PUTime=el('t2PUTime'), t3PUTime=el('t3PUTime');
const t1BonusBtn=el('t1BonusCredit'), t2BonusBtn=el('t2BonusCredit'), t3BonusBtn=el('t3BonusCredit');
const t1Plus=el('t1Plus'), t1Minus=el('t1Minus'), t2Plus=el('t2Plus'), t2Minus=el('t2Minus'), t3Plus=el('t3Plus'), t3Minus=el('t3Minus');
const t1Badges=el('t1Badges'), t2Badges=el('t2Badges'), t3Badges=el('t3Badges');
const roundNowEl=el('roundNow'), roundTotalEl=el('roundTotal'), roundFillEl=el('roundFill'), banner=el('banner'), endNote=el('endNote');
const exportCsvBtn=el('exportCsvBtn'), clearHistoryBtn=el('clearHistoryBtn'), statsBox=el('statsBox'), historyList=el('historyList'), historyCount=el('historyCount');
const teacherBtn=el('teacherBtn'), teacherBadge=el('teacherBadge');
const createGameBtn=el('createGameBtn'), joinGameBtn=el('joinGameBtn'), onlineInfo=el('onlineInfo');
const fullscreenBtn=el('fullscreenBtn'), instructionsBtn=el('instructionsBtn'), toggleInstr=el('toggleInstr'), instrBody=el('instrBody');
const currentTeamPill=el('currentTeamPill');
const modalWrap=el('modalWrap'), modalTitle=el('modalTitle'), modalBody=el('modalBody'), modalClose=el('modalClose');
const historyModalWrap=el('historyModalWrap'), histMeta=el('histMeta'), histPrompt=el('histPrompt'), histFood=el('histFood'), histAnswer=el('histAnswer'), histMC=el('histMC');

/* ================= STATE ================= */
let timerSeconds=30, currentTime=30, timerId=null, timerRunning=false;
let directionMode='EN2SY', qtype='FREE', players=2;
let currentPromptKey='', lastRenderedDir='EN2SY', lastRenderedMode='FREE';
let isBonus=false, currentFoodIndex=null;
let forceBonusForTeam=0; // which team made the next question a bonus
let canShowAnswer=false, answerUnlockTimeout=null, mcEnabled=false, selectedTeam=0, teamSelectable=true, teacherMode=false;
let score=[0,0,0,0]; // negatives allowed
let streak=[0,0,0,0]; // per team
let bonusCredits=[0,0,0,0]; // per-team
let gamesWon=[0,0,0,0];
let totalRounds=10, currentRound=1, roundStartScores=[0,0,0,0], justFinishedGame=false;
let mcOptions=[], pendingMCOutcome=null;
let unusedPrompts = Object.keys(PHRASES);
let eventsLog=[]; // for CSV / stats

/* ================= UTILS ================= */
const now=()=>Date.now();
function hexToRgba(hex,a){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);if(!m)return`rgba(0,0,0,${a})`;const r=parseInt(m[1],16),g=parseInt(m[2],16),b=parseInt(m[3],16);return`rgba(${r},${g},${b},${a})`;}
const teamName=(i)=> (i===1?t1Name.value.trim():i===2?t2Name.value.trim():t3Name.value.trim())||`Team ${i}`;
const teamColor=(i)=> i===1?t1Color.value:i===2?t2Color.value:t3Color.value;
function tintPill(el,color){el.style.background=hexToRgba(color,.12);el.style.color='#0F172A';el.style.borderColor=hexToRgba(color,.6);}
function setActiveTeamHighlight(){
  [t1Card,t2Card,players===3?t3Card:null].filter(Boolean).forEach((el,idx)=>el.classList.toggle('active', teamSelectable && selectedTeam===idx+1));
  if(!teamSelectable||selectedTeam===0){currentTeamPill.classList.add('hidden');currentTeamPill.textContent='Current Team: —';}
  else{currentTeamPill.textContent=`Current Team: ${teamName(selectedTeam)}`;tintPill(currentTeamPill,teamColor(selectedTeam));currentTeamPill.classList.remove('hidden');}
  tryApplyPendingMCOutcome();
}
function isFuture(key){ return key.toLowerCase().includes('will'); }
function detectPronSy(key){
  const p=key.toLowerCase();
  if(p.startsWith('i ')) return p.includes('(fem')?PRONOUNS.i_fem:PRONOUNS.i_masc;
  if(p.startsWith('you ')) return p.includes('(fem')?PRONOUNS.you_fem:PRONOUNS.you_masc;
  if(p.startsWith('he ')) return PRONOUNS.he;
  if(p.startsWith('she ')) return PRONOUNS.she;
  if(p.startsWith('we ')) return PRONOUNS.we;
  if(p.startsWith('they ')) return PRONOUNS.they;
  if(p.startsWith('y’all')) return PRONOUNS.yall;
  return '';
}
function buildSyAnswerFromKey(key, foodIndex){
  const base=PHRASES[key]||''; const fut=isFuture(key); const pron=detectPronSy(key);
  const verb=base.replace(/\s*ܒܸܕ\s*$/,'').trim();
  let out=fut?`${pron}  ܒܸܕ  ${verb}`:`${pron}  ${verb}`;
  if(foodIndex!=null) out+=`  ${FOODS_SY[foodIndex]}`;
  return out;
}
function englishPronounFromKey(key){ if(key.toLowerCase().startsWith('y’all'))return"y’all"; return key.split(' ')[0].replace('(masc.)','').replace('(fem.)','').trim(); }
function buildEnAnswerFromKey(key){
  const fut=isFuture(key); let pron=englishPronounFromKey(key); let base=fut?'will order':'orders';
  const p=pron.toLowerCase(); if(!fut&&(p==='i'||p==='we'||p==='they'||p==='y’all')) base='order';
  return `${pron} ${base}`;
}
function randomPromptFromPool(){
  const all=Object.keys(PHRASES);
  if(noRepeat.checked){
    if(unusedPrompts.length===0) unusedPrompts=[...all];
    const i=Math.floor(Math.random()*unusedPrompts.length);
    return unusedPrompts.splice(i,1)[0];
  }
  return all[Math.floor(Math.random()*all.length)];
}

/* ================= TIMER ================= */
function updateTimerLabel(){ timerLabel.textContent=isBonus?'45 sec':`${currentTime} sec`; }
function stopTimer(){ if(timerId){clearInterval(timerId);timerId=null;} timerRunning=false; }
function startTimer(){
  currentTime = isBonus ? 45 : timerSeconds;
  updateTimerLabel();
  stopTimer(); timerRunning=true;
  timerId=setInterval(()=>{ if(currentTime>0){ currentTime--; updateTimerLabel(); if(!canShowAnswer && (teacherMode || (!isBonus && currentTime<=timerSeconds-10) || (isBonus && currentTime<=45-10))){ unlockAfterDelay(); } } else { stopTimer(); } },1000);
}

/* ================= STREAKS / BONUS CREDITS ================= */
function incStreak(team, gotCorrect){
  streak[team]=gotCorrect?streak[team]+1:0;
  (team===1?t1StreakEl:team===2?t2StreakEl:t3StreakEl).textContent=`Streak: ${streak[team]}`;
  if(streak[team] && streak[team]%3===0){
    // +1 point, +1 bonus credit, +5s power-up
    score[team]+=1;
    bonusCredits[team]+=1;
    renderScores(); renderPUButtons();
    addBadge(team, '3-in-a-row');
  }
}
function renderPUButtons(){
  t1PUTime.textContent=`+5 sec (${streak[1] ? Math.floor(streak[1]/3) : 0})`;
  t2PUTime.textContent=`+5 sec (${streak[2] ? Math.floor(streak[2]/3) : 0})`;
  if(players===3) t3PUTime.textContent=`+5 sec (${streak[3] ? Math.floor(streak[3]/3) : 0})`;

  t1BonusBtn.textContent=`Activate Bonus (${bonusCredits[1]||0})`;
  t1BonusBtn.disabled = !(bonusCredits[1]>0);
  t2BonusBtn.textContent=`Activate Bonus (${bonusCredits[2]||0})`;
  t2BonusBtn.disabled = !(bonusCredits[2]>0);
  if(players===3){
    t3BonusBtn.textContent=`Activate Bonus (${bonusCredits[3]||0})`;
    t3BonusBtn.disabled = !(bonusCredits[3]>0);
  }
}
function spendExtraTime(team){
  // consume one +5sec credit if available (based on streaks bucket)
  if(Math.floor((streak[team]||0)/3) <= 0){ return; }
  // decrement a virtual bucket by reducing streak by 3 (keeps UI simple)
  streak[team] = Math.max(0, streak[team]-3);
  (team===1?t1StreakEl:team===2?t2StreakEl:t3StreakEl).textContent=`Streak: ${streak[team]}`;
  currentTime += 5; updateTimerLabel();
  renderPUButtons();
}
function activateTeamBonus(team){
  if(bonusCredits[team]<=0) return;
  bonusCredits[team]--; forceBonusForTeam=team; renderPUButtons();
  addBadge(team, 'Bonus Caller');
}

/* ================= ACHIEVEMENTS ================= */
const badges = { 1:new Set(), 2:new Set(), 3:new Set() };
function addBadge(team, label){
  if(badges[team].has(label)) return;
  badges[team].add(label);
  const container = team===1?t1Badges:team===2?t2Badges:t3Badges;
  const b=document.createElement('span'); b.className='badge'; b.textContent=label; container.appendChild(b);
}

/* ================= MC RENDER ================= */
function getUniqueDistractorKeys(correctKey, n){
  const pool=Object.keys(PHRASES).filter(k=>k!==correctKey); const out=new Set();
  while(out.size<n && pool.length){ out.add(pool.splice(Math.floor(Math.random()*pool.length),1)[0]); }
  return [...out];
}
function uniqueFoodIndices(count, excludeIndex){
  const ex = excludeIndex==null?new Set():new Set([excludeIndex]);
  const pool=[...Array(FOODS_EN.length).keys()].filter(i=>!ex.has(i));
  const res=[]; while(res.length<count && pool.length){ res.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]); }
  return res;
}
function ensureUniqueOptionTexts(build){
  for(let i=0;i<15;i++){ const opts=build(); const set=new Set(opts.map(o=>o.text)); if(set.size===opts.length) return opts; }
  return build();
}
function renderMC_EN2SY(correctKey){
  const isBonusRound = isBonus && currentFoodIndex!=null;
  const mode = isBonusRound ? (Math.random()<0.5?'ALL':'HALF') : 'NONE';
  const build=()=>{
    const D=getUniqueDistractorKeys(correctKey,3);
    if(mode==='ALL'){
      const foods=uniqueFoodIndices(3,currentFoodIndex);
      return [
        {text:buildSyAnswerFromKey(correctKey,currentFoodIndex),correct:true},
        {text:buildSyAnswerFromKey(D[0],foods[0]),correct:false},
        {text:buildSyAnswerFromKey(D[1],foods[1]),correct:false},
        {text:buildSyAnswerFromKey(D[2],foods[2]),correct:false},
      ].sort(()=>Math.random()-0.5);
    } else if(mode==='HALF'){
      const f=uniqueFoodIndices(1,currentFoodIndex)[0];
      return [
        {text:buildSyAnswerFromKey(correctKey,currentFoodIndex),correct:true},
        {text:buildSyAnswerFromKey(D[0],f),correct:false},
        {text:buildSyAnswerFromKey(D[1],null),correct:false},
        {text:buildSyAnswerFromKey(D[2],null),correct:false},
      ].sort(()=>Math.random()-0.5);
    } else {
      return [
        {text:buildSyAnswerFromKey(correctKey,null),correct:true},
        {text:buildSyAnswerFromKey(D[0],null),correct:false},
        {text:buildSyAnswerFromKey(D[1],null),correct:false},
        {text:buildSyAnswerFromKey(D[2],null),correct:false},
      ].sort(()=>Math.random()-0.5);
    }
  };
  mcOptions=ensureUniqueOptionTexts(build);
  mcWrap.innerHTML=''; mcOptions.forEach((opt,idx)=>{ const b=document.createElement('button'); b.className='opt'; b.textContent=opt.text; b.onclick=()=>onMCClick(idx); opt.button=b; mcWrap.appendChild(b); });
  enableMCOptions(teacherMode);
}
function renderMC_SY2EN(correctKey){
  const D=getUniqueDistractorKeys(correctKey,3);
  const build=()=>[
    {text:buildEnAnswerFromKey(correctKey),correct:true},
    {text:buildEnAnswerFromKey(D[0]),correct:false},
    {text:buildEnAnswerFromKey(D[1]),correct:false},
    {text:buildEnAnswerFromKey(D[2]),correct:false},
  ].sort(()=>Math.random()-0.5);
  mcOptions=ensureUniqueOptionTexts(build);
  mcWrap.innerHTML=''; mcOptions.forEach((o,i)=>{ const b=document.createElement('button'); b.className='opt'; b.textContent=o.text; b.onclick=()=>onMCClick(i); o.button=b; mcWrap.appendChild(b); });
  enableMCOptions(teacherMode);
}
function enableMCOptions(on){ mcEnabled=on; mcWrap.classList.toggle('hidden', !on && lastRenderedMode==='MC'); mcOptions.forEach(o=>{ o.button.classList.toggle('enabled', on); o.button.style.cursor=on?'pointer':'not-allowed'; }); }

/* Retro scoring support */
function tryApplyPendingMCOutcome(){
  if(!pendingMCOutcome || pendingMCOutcome.applied) return;
  if(selectedTeam===0) return;
  const delta = pendingMCOutcome.correct ? pendingMCOutcome.delta : -1;
  score[selectedTeam] += delta;
  incStreak(selectedTeam, pendingMCOutcome.correct);
  renderScores();
  pendingMCOutcome.applied=true;
}

/* MC click */
function onMCClick(idx){
  if(!mcEnabled) return;
  stopTimer();
  mcOptions.forEach(o=>{ if(o.correct) o.button.classList.add('correct'); });
  if(!mcOptions[idx].correct) mcOptions[idx].button.classList.add('wrong');
  enableMCOptions(false);
  const deltaCorrect = isBonus?2:1;
  pendingMCOutcome = {correct: mcOptions[idx].correct, delta: deltaCorrect, applied:false};
  tryApplyPendingMCOutcome();
  nextBtn.disabled=false;

  // log
  eventsLog.push({ts:now(), round:currentRound, dir:lastRenderedDir, mode:lastRenderedMode, bonus:isBonus, promptKey:currentPromptKey,
    promptText:promptLabel.textContent, correctKey:currentPromptKey, answeredAt:now(), teamAwarded:selectedTeam||null, correct:mcOptions[idx].correct, delta:mcOptions[idx].correct?deltaCorrect:-1});
}

/* ================= ROUNDS / FLOW ================= */
function setTeamSelectable(on){ teamSelectable=on; if(!on) selectedTeam=0; setActiveTeamHighlight(); }
function updateTimerLabel(){ timerLabel.textContent=isBonus?'45 sec':`${currentTime} sec`; }
function setupLocksForNewQuestion(){
  nextBtn.disabled=true;
  setTeamSelectable(lastRenderedMode!=='FREE');
  showAnswerBtn.disabled=(lastRenderedMode==='FREE' && !teacherMode);
  canShowAnswer = teacherMode;
  if(answerUnlockTimeout){clearTimeout(answerUnlockTimeout);answerUnlockTimeout=null;}
  if(!teacherMode){ answerUnlockTimeout=setTimeout(unlockAfterDelay, 10000); } else { unlockAfterDelay(); }
  if(lastRenderedMode==='FREE'){ showAnswerBtn.classList.remove('hidden'); answerLabel.classList.remove('hidden'); mcWrap.classList.add('hidden'); }
  else { showAnswerBtn.classList.add('hidden'); answerLabel.classList.add('hidden'); mcWrap.classList.remove('hidden'); enableMCOptions(teacherMode); }
}
function unlockAfterDelay(){ canShowAnswer=true; if(lastRenderedMode==='MC') enableMCOptions(true); else showAnswerBtn.disabled=false; }
function renderScores(){
  t1ScoreEl.textContent=score[1]; t2ScoreEl.textContent=score[2]; if(players===3) t3ScoreEl.textContent=score[3];
  const total=Math.max(1, Math.abs(score[1])+Math.abs(score[2])+(players===3?Math.abs(score[3]):0));
  t1Bar.style.width=(Math.abs(score[1])/total*100).toFixed(0)+'%';
  t2Bar.style.width=(Math.abs(score[2])/total*100).toFixed(0)+'%';
  t3Bar.style.width=(players===3?(Math.abs(score[3])/total*100).toFixed(0):'0')+'%';
}
function chooseActualMode(){ return qtype==='MIXED' ? (Math.random()<0.5?'FREE':'MC') : qtype; }
function finishRoundAndAdvance(){
  const d=[0, score[1]-roundStartScores[1], score[2]-roundStartScores[2], players===3?score[3]-roundStartScores[3]:-Infinity];
  let winTeam=0,max=-Infinity; [1,2].concat(players===3?[3]:[]).forEach(t=>{ if(d[t]>max){max=d[t];winTeam=t;} });
  banner.textContent=(max<=0)?'Round tied':`Round winner: ${teamName(winTeam)}`; banner.classList.remove('hidden');

  if(currentRound>=totalRounds){
    const arr=[1,2].concat(players===3?[3]:[]).map(t=>({t,s:score[t]}));
    const m=Math.max(...arr.map(v=>v.s)); const winners=arr.filter(v=>v.s===m).map(v=>v.t);
    if(winners.length===1){ gamesWon[winners[0]]++; modalTitle.textContent='Congratulations!'; modalBody.textContent=`Game winner: ${teamName(winners[0])}`; modalWrap.classList.remove('hidden'); }
    else { modalTitle.textContent='Game Tied'; modalBody.textContent='No game winner this time.'; modalWrap.classList.remove('hidden'); }
    updateGamesPanel();
    endNote.innerHTML='Please call over Mr. Sargool and show your results before clicking <strong>Next Question</strong>.<br>(Next game will begin and scores will be reset, but you can see the games counter below.)';
    endNote.classList.remove('hidden');
    nextBtn.textContent='Next Question (Next game will begin and scores will be reset …)';
    justFinishedGame=true;
  }
  if(currentRound<totalRounds){
    currentRound++; roundNowEl.textContent=String(currentRound);
    roundFillEl.style.width=((currentRound-1)/Math.max(1,totalRounds))*100+'%';
    roundStartScores=[0, score[1], score[2], players===3?score[3]:0];
  }
}
function updateGamesPanel(){
  const parts=[1,2].concat(players===3?[3]:[]).map(t=>`${teamName(t)}: ${gamesWon[t]}`);
  el('gamesTally').textContent=parts.join(' • ');
  const max=Math.max(...[1,2].concat(players===3?[3]:[]).map(t=>gamesWon[t]));
  const leaders=[1,2].concat(players===3?[3]:[]).filter(t=>gamesWon[t]===max);
  el('gameLeader').textContent=(leaders.length>1)?'Games leader: tied':`Games leader: ${teamName(leaders[0])}`;
}
function decideBonusForThisQuestion(){
  if(forceBonusForTeam){ const t=forceBonusForTeam; forceBonusForTeam=0; return true; }
  return Math.random()<0.20;
}
function nextQuestion(){
  if(!modalWrap.classList.contains('hidden')) return;
  if(justFinishedGame){ startNewGameHardReset(); return; }

  if(promptLabel.textContent) pushHistory();

  finishRoundAndAdvance();

  isBonus = decideBonusForThisQuestion();
  if(isBonus){
    currentFoodIndex = Math.floor(Math.random()*FOODS_EN.length);
    foodLabel.textContent=`Bonus Round: ${FOODS_EN[currentFoodIndex]}`;
    bonusPill.classList.remove('hidden');
  } else {
    currentFoodIndex=null; foodLabel.textContent=''; bonusPill.classList.add('hidden');
  }

  answerLabel.textContent=''; mcWrap.innerHTML=''; mcOptions=[]; pendingMCOutcome=null;

  directionMode=dirSelect.value; qtype=qtypeSelect.value; lastRenderedMode=chooseActualMode();
  lastRenderedDir = directionMode==='BOTH' ? (Math.random()<0.5?'EN2SY':'SY2EN') : directionMode;
  setupLocksForNewQuestion();

  currentPromptKey = randomPromptFromPool();
  if(lastRenderedDir==='EN2SY'){
    promptLabel.textContent=currentPromptKey;
    if(lastRenderedMode==='FREE'){ startTimer(); }
    else { renderMC_EN2SY(currentPromptKey); startTimer(); }
  } else {
    promptLabel.textContent = buildSyAnswerFromKey(currentPromptKey, currentFoodIndex);
    if(lastRenderedMode==='FREE'){ startTimer(); }
    else { renderMC_SY2EN(currentPromptKey); startTimer(); }
  }

  pushHostState(); // if online host, sync state
}
function showAnswer(){
  if(lastRenderedMode!=='FREE') return;
  if(!canShowAnswer && !teacherMode) return;
  stopTimer();
  answerLabel.textContent = (lastRenderedDir==='EN2SY') ? buildSyAnswerFromKey(currentPromptKey, currentFoodIndex) : buildEnAnswerFromKey(currentPromptKey);
  nextBtn.disabled=false;
}
function startNewGameHardReset(){
  score=[0,0,0,0]; streak=[0,0,0,0];
  bonusCredits=[0,0,0,0]; badges[1].clear(); badges[2].clear(); badges[3].clear();
  [t1Badges,t2Badges,t3Badges].forEach(b=>b.innerHTML='');
  renderPUButtons();
  renderScores();
  currentRound=1; roundNowEl.textContent='1'; roundFillEl.style.width='0%';
  banner.classList.add('hidden'); endNote.classList.add('hidden'); modalWrap.classList.add('hidden');
  justFinishedGame=false;
  setRounds(parseInt(roundsSelect.value,10));
  initFirstQuestion(true);
}
function setRounds(n){
  totalRounds=n; roundTotalEl.textContent=String(totalRounds);
  currentRound=1; roundNowEl.textContent='1'; roundFillEl.style.width='0%';
  banner.classList.add('hidden'); endNote.classList.add('hidden'); nextBtn.textContent='Next Question';
  roundStartScores=[0, score[1], score[2], players===3?score[3]:0];
}

/* ================= HISTORY & STATS ================= */
const history=[];
function pushHistory(){
  const snapshot = {
    ts: now(), round: currentRound, dir: lastRenderedDir, mode: lastRenderedMode, isBonus,
    foodIdx: currentFoodIndex, prompt: promptLabel.textContent,
    answerText: (lastRenderedDir==='EN2SY'?buildSyAnswerFromKey(currentPromptKey,currentFoodIndex):buildEnAnswerFromKey(currentPromptKey)),
    mcOptions: mcOptions.map(o=>({text:o.text, correct:o.correct}))
  };
  history.push(snapshot); if(history.length>500) history.shift();
  renderHistoryList(); renderStats();
}
function renderHistoryList(){
  historyCount.textContent=`${history.length} item${history.length===1?'':'s'}`;
  historyList.innerHTML='';
  history.forEach((h,i)=>{
    const box=document.createElement('div'); box.className='card'; box.style.padding='8px'; box.style.marginBottom='6px';
    const top=document.createElement('div'); top.innerHTML=`<strong>Q${i+1}</strong> • Round ${h.round} • ${h.dir} • ${h.mode}${h.isBonus?' • Bonus':''}<div class="note">${h.prompt}</div>`;
    const right=document.createElement('div'); const btn=document.createElement('button'); btn.className='btn neutral'; btn.textContent='View';
    btn.onclick=()=>openHistoryModal(h); right.appendChild(btn);
    const row=document.createElement('div'); row.className='row'; row.appendChild(top); row.appendChild(right);
    box.appendChild(row); historyList.appendChild(box);
  });
}
function openHistoryModal(h){
  histMeta.textContent=`Round ${h.round} • ${h.dir} • ${h.mode}${h.isBonus?' • Bonus':''}`;
  histPrompt.textContent=h.prompt;
  histFood.textContent=(h.isBonus&&h.foodIdx!=null)?`Bonus Food: ${FOODS_EN[h.foodIdx]}`:'';
  histAnswer.textContent=h.answerText;
  histMC.innerHTML='';
  if(h.mode==='MC' && h.mcOptions.length){
    h.mcOptions.forEach(o=>{
      const d=document.createElement('div'); d.className='opt '+(o.correct?'correct':'wrong'); d.textContent=o.text;
      histMC.appendChild(d);
    });
  }
  historyModalWrap.classList.remove('hidden');
}
el('historyClose').onclick=()=>historyModalWrap.classList.add('hidden');
clearHistoryBtn.onclick=()=>{ history.length=0; eventsLog.length=0; renderHistoryList(); renderStats(); };
function renderStats(){
  const totalMC=eventsLog.filter(e=>e.mode!=='FREE').length;
  const correct=eventsLog.filter(e=>e.correct).length;
  const acc = totalMC? Math.round((correct/totalMC)*100):0;
  const misses={}; eventsLog.filter(e=>!e.correct && e.promptKey).forEach(e=>{ misses[e.promptKey]=(misses[e.promptKey]||0)+1; });
  const topMiss = Object.entries(misses).sort((a,b)=>b[1]-a[1])[0];
  statsBox.innerHTML = `Total MC: ${totalMC}<br>Accuracy: ${acc}%<br>Most-missed: ${topMiss?`${topMiss[0]} (${topMiss[1]})`:'—'}`;
}
exportCsvBtn.onclick=()=>{
  const rows=[["timestamp","round","dir","mode","bonus","promptKey","promptText","teamAwarded","correct","delta"]];
  eventsLog.forEach(e=>rows.push([new Date(e.ts).toISOString(),e.round,e.dir,e.mode,e.bonus,e.promptKey,(e.promptText||'').replace(/\n/g,' '),e.teamAwarded??'',e.correct?'true':'false',e.delta??'']));
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='assyrian_game_stats.csv'; a.click(); URL.revokeObjectURL(url);
};

/* ================= TEACHER & MISC ================= */
teacherBtn.onclick=()=>{
  if(teacherMode){ teacherMode=false; teacherBadge.classList.add('hidden'); }
  else{ const pw=prompt('Enter teacher password:'); if(pw==='mrsargool'){ teacherMode=true; teacherBadge.classList.remove('hidden'); canShowAnswer=true; enableMCOptions(true); } else if(pw!==null){ alert('Incorrect password.'); } }
};
fullscreenBtn.onclick=()=>{ const de=document.documentElement; if(!document.fullscreenElement) de.requestFullscreen?.(); else document.exitFullscreen?.(); };
instructionsBtn.onclick=()=>{ instrBody.classList.toggle('hidden'); };
toggleInstr.onclick=()=>{ const hide=!instrBody.classList.contains('hidden'); instrBody.classList.toggle('hidden', hide); toggleInstr.textContent=hide?'Show':'Hide'; };

/* ================= BUTTONS ================= */
t1Plus.onclick=()=>{ score[1]+=1; renderScores(); incStreak(1,true); };
t1Minus.onclick=()=>{ score[1]-=1; renderScores(); incStreak(1,false); };
t2Plus.onclick=()=>{ score[2]+=1; renderScores(); incStreak(2,true); };
t2Minus.onclick=()=>{ score[2]-=1; renderScores(); incStreak(2,false); };
if(t3Plus) t3Plus.onclick=()=>{ score[3]+=1; renderScores(); incStreak(3,true); };
if(t3Minus) t3Minus.onclick=()=>{ score[3]-=1; renderScores(); incStreak(3,false); };

t1PUTime.onclick=()=>spendExtraTime(1);
t2PUTime.onclick=()=>spendExtraTime(2);
if(t3PUTime) t3PUTime.onclick=()=>spendExtraTime(3);

t1BonusBtn.onclick=()=>activateTeamBonus(1);
t2BonusBtn.onclick=()=>activateTeamBonus(2);
if(t3BonusBtn) t3BonusBtn.onclick=()=>activateTeamBonus(3);

[t1Card,t2Card,t3Card].forEach((el,idx)=>{ if(!el)return; const t=idx+1; el.onclick=()=>{ if(!teamSelectable) return; if(t===3 && players!==3) return; selectedTeam=t; setActiveTeamHighlight(); }; });
[t1Name,t2Name,t3Name].forEach((inp,i)=>{ if(!inp) return; inp.addEventListener('input',()=>{ const t=i+1; (t===1?t1Title:t===2?t2Title:t3Title).textContent=teamName(t); setActiveTeamHighlight(); updateGamesPanel(); }); });
[t1Color,t2Color,t3Color].forEach((inp,i)=>{ if(!inp) return; inp.oninput=()=>{ const t=i+1; const card=t===1?t1Card:t===2?t2Card:t3Card; const bar=t===1?t1Bar:t===2?t2Bar:t3Bar; card.style.background=hexToRgba(inp.value,.10); card.style.borderColor=hexToRgba(inp.value,.6); bar.style.background=inp.value; if(selectedTeam===t) tintPill(currentTeamPill, inp.value); }; });

el('resetGameBtn').onclick=startNewGameHardReset;
resetScoresBtn.onclick=()=>{ score=[0,0,0,0]; streak=[0,0,0,0]; t1StreakEl.textContent='Streak: 0'; t2StreakEl.textContent='Streak: 0'; if(players===3) t3StreakEl.textContent='Streak: 0'; renderScores(); banner.classList.add('hidden'); roundStartScores=[0,score[1],score[2],players===3?score[3]:0]; };
nextBtn.onclick=nextQuestion;
showAnswerBtn.onclick=showAnswer;

timerSelect.onchange=(e)=>{ timerSeconds=parseInt(e.target.value,10); };
roundsSelect.onchange=(e)=>{ setRounds(parseInt(e.target.value,10)); };
playersSelect.onchange=()=>{ players=parseInt(playersSelect.value,10); t3Card.classList.toggle('hidden', players!==3); renderScores(); updateGamesPanel(); };

/* ================= KEYBOARD ================= */
document.addEventListener('keydown',(e)=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT') return;
  if(e.key===' '){ e.preventDefault(); if(isBonus) return; if(timerRunning){ stopTimer(); } else { startTimer(); } }
  if(e.key==='Enter'){ e.preventDefault(); if(!nextBtn.disabled) nextQuestion(); }
  if(e.key.toLowerCase()==='a'){ e.preventDefault(); if(lastRenderedMode==='FREE'&&(canShowAnswer||teacherMode)) showAnswer(); }
});

/* ================= ONLINE (FIREBASE) ================= */
import { firebaseConfig as _cfg } from '#firebase-config';
let online=false, isHost=false, gameId=null, db=null, gameRef=null;
let Firebase=null;

async function initFirebase(){
  try{
    if(!_cfg) return null;
  }catch{ return null; }
  const appMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
  const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
  const app = appMod.initializeApp(_cfg);
  db = fsMod.getFirestore(app);
  Firebase = {doc:fsMod.doc,setDoc:fsMod.setDoc,updateDoc:fsMod.updateDoc,onSnapshot:fsMod.onSnapshot};
  return Firebase;
}

// simple virtual module shim to import config above
const cfgScript = document.querySelector('#firebase-config');
const cfgText = cfgScript?.textContent || '';
const hasCfg = cfgText.includes('export const firebaseConfig');
const blob = new Blob([cfgText||'export const firebaseConfig = null;'], {type:'text/javascript'});
const cfgUrl = URL.createObjectURL(blob);
const moduleMap = new Map(); // trivial loader
// eslint-disable-next-line no-unused-vars
const importMapShim = (id)=> (id==='#firebase-config'?cfgUrl:id);

const origImport = window.importShim || ((x)=>import(x));
window.importShim = async (id)=> origImport(importMapShim(id));

// Hook Create / Join buttons
createGameBtn.onclick = async ()=>{
  const fb = await initFirebase();
  if(!fb){ alert('Online play: please paste your Firebase config (see the FIREBASE CONFIG block) and try again.'); return; }
  isHost=true; online=true; gameId = Math.random().toString(36).slice(2,8).toUpperCase();
  onlineInfo.classList.remove('hidden'); onlineInfo.textContent=`HOST • PIN ${gameId}`;
  gameRef = Firebase.doc(db,'games',gameId);
  await Firebase.setDoc(gameRef,{ state:null, scores:{1:0,2:0,3:0}, ts:Date.now() });
  Firebase.onSnapshot(gameRef,(snap)=>{ const g=snap.data(); if(!g) return; if(!isHost && g.state){ applyRemoteState(g.state); } if(g.scores){ score[1]=g.scores[1]; score[2]=g.scores[2]; score[3]=g.scores[3]; renderScores(); } });
  alert(`Share PIN ${gameId}. Students click Join Online Game and enter the PIN.`);
};
joinGameBtn.onclick = async ()=>{
  const fb = await initFirebase();
  if(!fb){ alert('Online play: please paste your Firebase config (see the FIREBASE CONFIG block) and try again.'); return; }
  const pin=prompt('Enter Game PIN:'); if(!pin) return;
  isHost=false; online=true; gameId=pin.trim().toUpperCase();
  onlineInfo.classList.remove('hidden'); onlineInfo.textContent=`PLAYER • PIN ${gameId}`;
  gameRef = Firebase.doc(db,'games',gameId);
  Firebase.onSnapshot(gameRef,(snap)=>{ const g=snap.data(); if(!g) return; if(g.state) applyRemoteState(g.state); if(g.scores){ score[1]=g.scores[1]; score[2]=g.scores[2]; score[3]=g.scores[3]; renderScores(); } });
};

// Host pushes state after rendering a new question
async function pushHostState(){
  if(!online||!isHost||!gameRef) return;
  const state = {
    round: currentRound, dir:lastRenderedDir, mode:lastRenderedMode, isBonus, timer:isBonus?45:timerSeconds,
    promptKey: currentPromptKey, promptText: promptLabel.textContent, foodIndex: currentFoodIndex,
    options: mcOptions.map(o=>({t:o.text,c:o.correct}))
  };
  await Firebase.updateDoc(gameRef,{ state, scores:{1:score[1],2:score[2],3:players===3?score[3]:0}, ts:Date.now() });
}
function applyRemoteState(s){
  currentRound=s.round; roundNowEl.textContent=String(currentRound);
  lastRenderedDir=s.dir; lastRenderedMode=s.mode; isBonus=s.isBonus; currentFoodIndex=s.foodIndex; currentPromptKey=s.promptKey;
  bonusPill.classList.toggle('hidden', !isBonus);
  promptLabel.textContent=s.promptText; foodLabel.textContent=isBonus?`Bonus Round: ${FOODS_EN[currentFoodIndex]}`:'';
  mcWrap.innerHTML=''; mcOptions = (s.options||[]).map(o=>({text:o.t,correct:o.c}));
  mcOptions.forEach((opt,i)=>{ const b=document.createElement('button'); b.className='opt enabled'; b.textContent=opt.text; b.onclick=()=>onMCClick(i); opt.button=b; mcWrap.appendChild(b); });
  enableMCOptions(true);
  startTimer();
}

/* ================= INIT ================= */
function updateGamesPanel(){
  const parts=[1,2].concat(players===3?[3]:[]).map(t=>`${teamName(t)}: ${gamesWon[t]}`);
  document.getElementById('gamesTally').textContent=parts.join(' • ');
  const max=Math.max(...[1,2].concat(players===3?[3]:[]).map(t=>gamesWon[t]));
  const leaders=[1,2].concat(players===3?[3]:[]).filter(t=>gamesWon[t]===max);
  document.getElementById('gameLeader').textContent=(leaders.length>1)?'Games leader: tied':`Games leader: ${teamName(leaders[0])}`;
}
function initFirstQuestion(forceFresh=false){
  timerSeconds=parseInt(timerSelect.value,10);
  totalRounds=parseInt(roundsSelect.value,10); roundTotalEl.textContent=String(totalRounds);
  if(forceFresh){ currentRound=1; roundNowEl.textContent='1'; roundFillEl.style.width='0%'; }
  renderScores(); renderPUButtons(); updateGamesPanel();
  currentPromptKey=randomPromptFromPool();
  lastRenderedDir=dirSelect.value==='BOTH'?(Math.random()<0.5?'EN2SY':'SY2EN'):dirSelect.value;
  lastRenderedMode=qtypeSelect.value==='MIXED'?(Math.random()<0.5?'FREE':'MC'):qtypeSelect.value;
  isBonus=false; currentFoodIndex=null; foodLabel.textContent=''; bonusPill.classList.add('hidden');
  setupLocksForNewQuestion();
  if(lastRenderedDir==='EN2SY'){ promptLabel.textContent=currentPromptKey; if(lastRenderedMode==='MC') renderMC_EN2SY(currentPromptKey); }
  else { promptLabel.textContent=buildSyAnswerFromKey(currentPromptKey,currentFoodIndex); if(lastRenderedMode==='MC') renderMC_SY2EN(currentPromptKey); }
  startTimer();
}
(function(){ initFirstQuestion(); })();

/* Expose for host sync */
window.pushHostState = pushHostState;
</script>
</body>
</html>
